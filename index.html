<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€è°·é›†æˆä¸€ä½“æœºv1.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            /* è‰²å½©æ­é… */
            --bg-color: #f6f6ff;
            --card-bg: #ffffff;
            --primary-color: #747fdb;
            /* ä¸»è‰²è°ƒ (ä¸­ç­‰è“ç´«è‰²) */
            --primary-hover-color: #5f69c3;
            /* ä¸»è‰²è°ƒæ‚¬æµ® */
            --secondary-color: #2029b6;
            /* è¾…è‰²/å¼ºè°ƒè‰² (äº®è“è‰²) */
            --accent-color: #c72729;
            /* è­¦ç¤º/å±é™©è‰² (çº¢è‰²) */
            --accent-hover-color: #a32022;
            /* è­¦ç¤ºè‰²æ‚¬æµ® */
            --success-color: #2029b6;
            /* æˆåŠŸ/æ·»åŠ è‰² (åŒè¾…è‰²) */
            --success-hover-color: #1a218f;
            /* æˆåŠŸè‰²æ‚¬æµ® */
            --text-color: #1a1a2c;
            /* ä¸»è¦æ–‡å­—é¢œè‰² */
            --light-text-color: #667085;
            /* æ¬¡è¦æ–‡å­—é¢œè‰² */
            --border-color: #e1e1ed;
            /* è¾¹æ¡†é¢œè‰² */
            --highlight-bg: #e1e1ed;
            /* é«˜äº®åŒºåŸŸèƒŒæ™¯è‰² */
            --button-alt-bg: #a5adde;
            /* å¤‡ç”¨æŒ‰é’®èƒŒæ™¯è‰² */
            --button-alt-hover-bg: #8c96c4;
            /* å¤‡ç”¨æŒ‰é’®æ‚¬æµ® */

            /* è®¾è®¡é£æ ¼ */
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --border-radius: 0px;
            /* ç›´è§’è®¾è®¡æ ¸å¿ƒ */
        }

        body {
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1300px;
        }

        h1,
        h2 {
            color: var(--secondary-color);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 40px;
        }

        h3 {
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .calc-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--light-text-color);
        }

        .input-group input[type="number"],
        .input-group input[type="text"] {
            width: calc(100% - 22px);
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            background-color: var(--bg-color);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(116, 127, 219, 0.3);
        }

        .result-field,
        .display-field {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1em;
            padding: 8px 10px;
            background-color: var(--highlight-bg);
            border-radius: var(--border-radius);
            display: inline-block;
            min-width: 40px;
            text-align: center;
        }

        .final-result {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.2em;
        }

        .info-text {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 8px;
            background: var(--highlight-bg);
            padding: 8px;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
        }

        .warning-text {
            font-size: 0.8em;
            color: var(--accent-color);
            margin-left: 5px;
        }

        button,
        .button,
        .add-row-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-block;
            text-decoration: none;
        }

        button:hover,
        .button:hover,
        .add-row-btn:hover {
            background-color: var(--primary-hover-color);
        }

        .add-row-btn {
            background-color: var(--button-alt-bg);
            color: var(--text-color);
            margin-top: 10px;
        }

        .add-row-btn:hover {
            background-color: var(--button-alt-hover-bg);
        }

        .remove-btn-text,
        .add-btn-text {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            padding: 0 5px;
            vertical-align: middle;
            line-height: 1;
            transition: color 0.2s;
        }

        .remove-btn-text {
            color: var(--accent-color);
        }

        .add-btn-text {
            color: var(--success-color);
        }

        .remove-btn-text:hover {
            color: var(--accent-hover-color);
        }

        .add-btn-text:hover {
            color: var(--success-hover-color);
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: var(--highlight-bg);
            color: var(--text-color);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .item-tab-button.add-new-item-type-btn {
            background-color: var(--success-color);
            color: white;
        }

        .item-tab-button.add-new-item-type-btn:hover {
            background-color: var(--success-hover-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background-color: var(--highlight-bg);
            font-weight: 600;
            color: var(--text-color);
        }

        td input[type="text"],
        td input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px;
        }

        th.col-name,
        td.col-name {
            min-width: 120px;
        }

        th.col-status,
        td.col-status {
            width: 70px;
        }

        th.col-value,
        td.col-value {
            width: 70px;
        }

        th.col-distribution,
        td.col-distribution {
            min-width: 190px;
        }

        th.col-operation,
        td.col-operation {
            width: 70px;
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .table-scroll-wrapper table {
            min-width: 780px;
            border: none;
        }

        .distribution-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dist-entry {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .dist-entry input[type="text"] {
            flex: 2;
            min-width: 70px;
            padding: 6px 8px;
            box-sizing: border-box;
        }

        .dist-entry input[type="number"] {
            flex: 1;
            min-width: 50px;
            padding: 6px 8px;
            box-sizing: border-box;
        }

        .item-config-header {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            align-items: center;
        }

        .item-config-header .input-group {
            margin: 0;
        }

        #order-plan-output,
        #total-bill-output,
        #total-items-output,
        #check-total-output {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--highlight-bg);
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
        }

        .footer-credit {
            font-style: italic;
            opacity: 0.6;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
            color: var(--light-text-color);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        #archive-button {
            background-color: var(--success-color);
        }

        #archive-button:hover {
            background-color: var(--success-hover-color);
        }

        #reset-button {
            background-color: var(--accent-color);
        }

        #reset-button:hover {
            background-color: var(--accent-hover-color);
        }

        #export-table-button {
            background-color: var(--button-alt-bg);
            color: var(--text-color);
        }

        #export-table-button:hover {
            background-color: var(--button-alt-hover-bg);
        }

        #data-sync-button {
            background-color: var(--primary-color);
        }

        #data-sync-button:hover {
            background-color: var(--primary-hover-color);
        }

        #load-button {
            background-color: var(--primary-color);
        }

        #load-button:hover {
            background-color: var(--primary-hover-color);
        }

        #export-options-modal,
        #data-sync-modal,
        #load-modal {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border-radius: var(--border-radius);
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #export-options-modal h3,
        #data-sync-modal h3,
        #load-modal h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: var(--primary-color);
        }

        .modal-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            display: block;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: var(--primary-hover-color);
        }

        #export-options-modal .cancel-button,
        #data-sync-modal .cancel-button,
        #load-modal .cancel-button {
            background-color: var(--light-text-color);
        }

        #export-options-modal .cancel-button:hover,
        #data-sync-modal .cancel-button:hover,
        #load-modal .cancel-button:hover {
            background-color: #555555;
        }

        .tooltip-trigger {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: var(--border-radius);
            /* Changed to square */
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.75em;
            vertical-align: middle;
            user-select: none;
            transition: background-color 0.2s;
        }

        .tooltip-trigger:hover {
            background-color: var(--primary-hover-color);
        }

        .tooltip-content {
            display: none;
            position: absolute;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            z-index: 1001;
            width: 320px;
            max-width: calc(100vw - 40px);
            font-size: 0.9em;
            color: var(--text-color);
            line-height: 1.5;
        }

        .tooltip-content p,
        .tooltip-content ul,
        .tooltip-content ol {
            margin-bottom: 10px;
        }

        .tooltip-content strong {
            color: var(--secondary-color);
        }

        .tooltip-content ul,
        .tooltip-content ol {
            padding-left: 20px;
        }

        .tooltip-content li {
            margin-bottom: 5px;
        }

        #qr-code-container {
            margin-bottom: 15px;
        }

        #qr-code-placeholder {
            color: var(--light-text-color);
            text-align: center;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #qr-code-placeholder:hover {
            background-color: var(--highlight-bg);
        }

        #qr-image-preview-container {
            display: block;
            /* ä» flex æ”¹ä¸º blockï¼Œç¡®ä¿å›¾ç‰‡å‚ç›´å †å å¹¶å æ»¡å®½åº¦ */
            margin-top: 10px;
        }

        /* QR Code Image Container with Delete Button */
        .qr-image-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
            /* å¢åŠ å›¾ç‰‡é—´è· */
            cursor: pointer;
            /* æç¤ºç”¨æˆ·å›¾ç‰‡æ˜¯å¯ç‚¹å‡»çš„ */
        }

        .qr-image-wrapper img {
            width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            object-fit: contain;
            display: block;
        }

        .qr-delete-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, opacity 0.2s, transform 0.2s;
            padding: 0;
            opacity: 0;
            /* é»˜è®¤å®Œå…¨é€æ˜ */
            pointer-events: none;
            /* é»˜è®¤ä¸å¯äº¤äº’ */
            transform: scale(0.8);
            /* é»˜è®¤ç¼©å°ä¸€ç‚¹ï¼Œå‡ºç°æ—¶æœ‰åŠ¨ç”»æ•ˆæœ */
            z-index: 5;
        }

        /* å½“å›¾ç‰‡åŒ…è£…å™¨è¢«ç‚¹å‡»åï¼Œæ·»åŠ è¿™ä¸ªç±»ï¼Œä½¿åˆ é™¤æŒ‰é’®å‡ºç° */
        .qr-image-wrapper.show-delete .qr-delete-button {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }

        .qr-delete-button:hover {
            background-color: var(--accent-hover-color);
        }

        /* Autocomplete Suggestions Box Styles */
        #autocomplete-suggestions {
            display: none;
            position: fixed;
            /* ä½¿ç”¨å›ºå®šå®šä½ï¼Œä¸å—çˆ¶å…ƒç´ å½±å“ */
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            z-index: 1002;
            /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ */
            max-height: 150px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: var(--highlight-bg);
            color: var(--secondary-color);
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 id="main-title">å¼€è°·é›†æˆä¸€ä½“æœº ğŸ’–</h1>
        <p class="footer-credit" style="margin-top: -10px; margin-bottom: 10px;">All by Keichi & Gemini</p>
        <p id="version-info"
            style="text-align: center; color: var(--light-text-color); font-size: 0.9em; margin-top: -5px; margin-bottom: 15px;">
            v1.2</p>

        <div class="action-buttons">
            <button id="archive-button" onclick="archiveData()">ğŸ’¾ å­˜å‚¨æ¡£æ¡ˆ</button>
            <button id="load-button" onclick="showLoadModal()">ğŸ“‚ è¯»å–æ¡£æ¡ˆ</button>
            <button id="reset-button" onclick="resetCurrentSlotData()">ğŸ”„ é‡ç½®æ•°æ®</button>
            <button id="data-sync-button" onclick="showDataSyncModal()">ğŸ“¡ æ•°æ®äº’é€š</button>
            <button id="export-table-button" onclick="showExportOptions()">ğŸ“¤ å¯¼å‡ºè¡¨æ ¼</button>
        </div>

        <p id="current-slot-display"
            style="color: var(--primary-color); font-size: 0.9em; font-weight: bold; margin-bottom: 2px; text-align: left;">
            å½“å‰å­˜æ¡£: -</p>
        <p id="last-auto-save-time"
            style="color: var(--light-text-color); font-size: 0.9em; font-style: italic; margin-bottom: 10px; text-align: left;">
            ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: å°šæœªè‡ªåŠ¨ä¿å­˜</p>
        <p
            style="color: var(--light-text-color); font-size: 0.8em; font-style: italic; margin-top: -8px; margin-bottom: 10px; text-align: left;">
            PSï¼šæ•°æ®å­˜å‚¨åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šè¿›è¡Œäº‘ç«¯ä¸Šä¼ ï¼Œè¯·æ³¨æ„ä¿å­˜å™¢</p>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('calculator-section')">â‘  è®¡ç®—å™¨</button>
            <button class="tab-button" onclick="showTab('tables-section')">â‘¡ æ’è¡¨</button>
            <button class="tab-button" onclick="showTab('remaining-section')">â‘¢ ä½™é‡</button>
            <button class="tab-button" onclick="showTab('summary-section')">â‘£ è‚¾è¡¨</button>
        </div>

        <section id="calculator-section" class="card tab-content active">
            <h2>ã€è®¡ç®—å™¨ã€‘</h2>
            <div class="calculator-grid">
                <div class="calc-section">
                    <h3>æœ¬æ¬¡å¼€è°·</h3>
                    <p class="info-text" style="margin-bottom: 15px;">å…·ä½“å‚æ•°åœ¨å¯¹åº”çš„æ’è¡¨å¤„ä¿®æ”¹à­§( à¥‘à´§ à¥‘)à­¨</p>
                    <div class="input-group"><label id="postcard-price-label">çš®è‚¤æ˜ä¿¡ç‰‡ - ä»·æ ¼</label><span
                            id="postcard-price-display" class="display-field">28</span></div>
                    <div class="input-group"><label id="postcard-sets-label">çš®è‚¤æ˜ä¿¡ç‰‡ - é…æ•°</label><span
                            id="postcard-sets-display" class="display-field">0</span></div>
                    <hr>
                    <div class="input-group"><label id="resume-price-label">äººäº‹éƒ¨ç®€å† - ä»·æ ¼</label><span
                            id="resume-price-display" class="display-field">24</span></div>
                    <div class="input-group"><label id="resume-sets-label">äººäº‹éƒ¨ç®€å† - é…æ•°</label><span
                            id="resume-sets-display" class="display-field">0</span></div>
                    <hr>
                    <div class="input-group"><label id="pass1-price-label">é€šè¡Œè¯A - ä»·æ ¼</label><span
                            id="pass1-price-display" class="display-field">350</span></div>
                    <div class="input-group"><label id="pass1-sets-label">é€šè¡Œè¯A - ç›’æ•°</label><span id="pass1-sets-display"
                            class="display-field">0</span></div>
                    <hr>
                    <div class="input-group"><label id="pass2-price-label">é€šè¡Œè¯B - ä»·æ ¼</label><span
                            id="pass2-price-display" class="display-field">350</span></div>
                    <div class="input-group"><label id="pass2-sets-label">é€šè¡Œè¯B - ç›’æ•°</label><span id="pass2-sets-display"
                            class="display-field">0</span></div>
                    <hr>
                    <div class="input-group"><label id="sticker-price-label">è´´çº¸ - ä»·æ ¼</label><span
                            id="sticker-price-display" class="display-field">20</span></div>
                    <div class="input-group"><label id="sticker-sets-label">è´´çº¸ - åŒ…æ•°</label><span
                            id="sticker-sets-display" class="display-field">0</span></div>

                    <div id="dynamic-items-opening-display">
                        <!-- Dynamically added item displays will go here -->
                    </div>
                    <hr>
                    <p>å•é¢†æ€»é¢: <span id="single-item-total" class="result-field">0.00</span> å…ƒ</p>
                    <p>é€šè¡Œè¯å¤–æ€»é¢: <span id="total-excluding-pass" class="result-field">0.00</span> å…ƒ</p>
                    <p>æŠ˜å‰æ€»é¢: <span id="total-before-discount" class="result-field">0.00</span> å…ƒ</p>
                    <p>æŠ˜åæ€»é¢: <span id="total-after-discount" class="final-result">0.00</span> å…ƒ</p>
                </div>

                <div class="calc-section">
                    <h3>ç‰¹å…¸ç›¸å…³</h3>
                    <div class="input-group"><label>ä¸€æ¡£ç‰¹å…¸ (ä¸‹å•å³å¾—) - ä»·å€¼</label><input type="number" id="bonus1-value"
                            value="5"></div>
                    <div class="input-group"><label>äºŒæ¡£ç‰¹å…¸ - é—¨æ§› (æ»¡ X å…ƒ)</label><input type="number" id="bonus2-threshold"
                            value="219"></div>
                    <div class="input-group"><label>äºŒæ¡£ç‰¹å…¸ - ä»·å€¼</label><input type="number" id="bonus2-value" value="20">
                    </div>
                    <div class="input-group"><label><input type="checkbox" id="enable-bonus3" onchange="toggleBonus3()">
                            å¯ç”¨ä¸‰æ¡£ç‰¹å…¸</label></div>
                    <div id="bonus3-section" style="display:none;">
                        <div class="input-group"><label>ä¸‰æ¡£ç‰¹å…¸ - é—¨æ§› (æ»¡ X å…ƒ)</label><input type="number"
                                id="bonus3-threshold" value="500"></div>
                        <div class="input-group"><label>ä¸‰æ¡£ç‰¹å…¸ - ä»·å€¼</label><input type="number" id="bonus3-value"
                                value="0"></div>
                    </div>
                    <hr>
                    <p>è·å¾—ä¸€æ¡£ç‰¹å…¸: <span id="bonus1-count" class="result-field">0</span> ä»½</p>
                    <p>è·å¾—äºŒæ¡£ç‰¹å…¸: <span id="bonus2-count" class="result-field">0</span> ä»½</p>
                    <p>è·å¾—ä¸‰æ¡£ç‰¹å…¸: <span id="bonus3-count" class="result-field">0</span> ä»½</p>
                    <p>ç‰¹å…¸æ€»ä»·å€¼: <span id="bonus-total-value" class="final-result">0.00</span> å…ƒ</p>
                    <hr>
                    <p class="info-text" style="color: #4a6a86; font-style: italic;">
                        ä¸‹å•æ–¹æ¡ˆå’Œç‰¹å…¸ä»½æ•°ä»…ä¾›å‚è€ƒï¼ˆå¯èƒ½ä¸æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼‰ï¼Œè¯·åŠ¡å¿…è‡ªè¡Œæ ¸å¯¹å’ŒäºŒæ¬¡ç¡®è®¤ç‰¹å…¸ä»½æ•°ï¼Œä¸è¦è¿‡äºç›¸ä¿¡ç¬¨ç¬¨AIå–µQAQ</p>
                    <div class="input-group"><label>è‡ªå®šä¹‰ä¸€æ¡£ä»½æ•° (ç•™ç©ºåˆ™æŒ‰æ–¹æ¡ˆ)</label><input type="number"
                            id="bonus1-count-manual" placeholder="-" min="0"></div>
                    <div class="input-group"><label>è‡ªå®šä¹‰äºŒæ¡£ä»½æ•° (ç•™ç©ºåˆ™æŒ‰æ–¹æ¡ˆ)</label><input type="number"
                            id="bonus2-count-manual" placeholder="-" min="0"></div>
                    <div id="bonus3-manual-section" style="display:none;">
                        <div class="input-group"><label>è‡ªå®šä¹‰ä¸‰æ¡£ä»½æ•° (ç•™ç©ºåˆ™æŒ‰æ–¹æ¡ˆ)</label><input type="number"
                                id="bonus3-count-manual" placeholder="-" min="0"></div>
                    </div>
                    <div id="bonus-gap-info" class="info-text"></div>
                </div>

                <div class="calc-section">
                    <h3>å…¶ä»–æŠ˜æ‰£</h3>
                    <div class="input-group"><label>æ¯æ»¡ X å…ƒå‡ Y å…ƒ (å¹³å°åˆ¸)</label>æ¯æ»¡ <input type="number"
                            id="manjian-threshold" value="300" style="width: 60px;"> å‡ <input type="number"
                            id="manjian-value" value="50" style="width: 60px;"></div>
                    <div class="input-group"><label>88VIP æŠ˜æ‰£ (ä¸å¡«ä¸º1ï¼ŒæŒ‰å®ä»˜è®¡ç®—)</label><input type="number" id="vip-discount"
                            placeholder="ä¾‹å¦‚: 0.95" step="0.01"></div>
                    <div class="input-group"><label>è´­ç‰©é‡‘ æŠ˜æ‰£ (ä¸å¡«ä¸º1ï¼Œæœ€ç»ˆè®¡ç®—)</label><input type="number" id="gold-discount"
                            placeholder="ä¾‹å¦‚: 0.9" step="0.01"></div>
                    <div id="extra-discounts"></div>
                    <button onclick="addExtraDiscount()">å¢åŠ å¤‡ç”¨æŠ˜æ‰£</button>
                    <hr>
                    <div class="input-group"><label>æ»¡300-20ä¼˜æƒ åˆ¸ (å¼ æ•°)</label><input type="number" id="coupon-300-20"
                            value="0" min="0"></div>
                    <div class="input-group"><label>æ»¡200-10ä¼˜æƒ åˆ¸ (å¼ æ•°)</label><input type="number" id="coupon-200-10"
                            value="0" min="0"></div>
                    <div id="extra-coupons"></div>
                    <button onclick="addExtraCoupon()">å¢åŠ å¤‡ç”¨ä¼˜æƒ åˆ¸</button>
                    <p class="info-text" style="color: var(--accent-color); font-weight: bold; margin-top: 10px;">
                        ã€åªå¡«å†™èƒ½ç”¨çš„ï¼Œä¼šç›´æ¥è®¡å…¥æŠ˜æ‰£ï¼ã€‘</p>
                </div>

                <div class="calc-section full-width">
                    <h3>æœ€ç»ˆæŠ˜æ‰£ <span class="tooltip-trigger" data-tooltip-target="final-discount-tooltip">?</span></h3>
                    <div class="tooltip-content" id="final-discount-tooltip"></div>
                    <p>æœ€ç»ˆæŠ˜æ‰£: <span id="final-discount-rate" class="final-result">N/A</span></p>
                    <p><span id="final-postcard-name-display">çš®è‚¤æ˜ä¿¡ç‰‡</span>å‡ä»·: <span id="final-postcard-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <p><span id="final-resume-name-display">äººäº‹éƒ¨ç®€å†</span>å‡ä»·: <span id="final-resume-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <p><span id="final-pass1-name-display">é€šè¡Œè¯A</span>å‡ä»·: <span id="final-pass1-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <p><span id="final-pass2-name-display">é€šè¡Œè¯B</span>å‡ä»·: <span id="final-pass2-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <p><span id="final-sticker-name-display">è´´çº¸</span>å‡ä»· (å¼ ): <span id="final-sticker-single-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <p><span id="final-sticker-pair-name-display">è´´çº¸</span>å‡ä»· (å¯¹): <span id="final-sticker-pair-price"
                            class="result-field">0.00</span> å…ƒ</p>
                    <div id="dynamic-items-final-discount-display">
                        <!-- Dynamically added item final prices will go here -->
                    </div>
                </div>

                <div class="calc-section full-width">
                    <h3>ä¸‹å•æ–¹æ¡ˆ <span class="tooltip-trigger" data-tooltip-target="order-plan-tooltip">?</span></h3>
                    <div class="tooltip-content" id="order-plan-tooltip"></div>
                    <div class="input-group"><label>åŒ…é‚®é—¨æ§› (å…ƒ)</label><input type="number" id="free-shipping-threshold"
                            value="99"></div>
                    <div class="input-group"><label>é‚®è´¹ (å…ƒ)</label><input type="number" id="shipping-fee" value="8">
                    </div>
                    <button onclick="calculateAll(); calculateSummary();">âœ¨ ç‚¹å‡»ç”Ÿæˆ/æ›´æ–°æœ€ä½³æ–¹æ¡ˆ âœ¨</button>
                    <div class="copy-button-container">
                        <button class="copy-button" onclick="copyToClipboard('order-plan-output', this)">ğŸ“‹ å¤åˆ¶</button>
                        <div id="order-plan-output">è¯·å…ˆå¡«å†™ä¸Šæ–¹ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»æŒ‰é’®ç”Ÿæˆæ–¹æ¡ˆ...</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tables-section" class="card tab-content">
            <h2>ã€æ’è¡¨ã€‘</h2>
            <div class="tabs" id="item-tabs"></div>
            <div id="item-tables-container"></div>
        </section>
        <section id="remaining-section" class="card tab-content">
            <h2>ã€ä½™é‡ã€‘</h2>
            <button onclick="updateRemainingTable()">ğŸ”„ æ›´æ–°ä½™é‡</button>
            <div class="copy-button-container">
                <button class="copy-button" onclick="copyToClipboard('remaining-output', this)">ğŸ“‹ å¤åˆ¶</button>
                <div id="remaining-output" style="margin-top: 20px;">
                    <p style="color: var(--light-text-color); text-align: center; font-style: italic;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ›´æ–°ä½™é‡è¡¨æ ¼...
                    </p>
                </div>
            </div>

        </section>

        <section id="summary-section" class="card tab-content">
            <h2>ã€è‚¾è¡¨ã€‘</h2>
            <button onclick="calculateSummary()">ğŸš€ è®¡ç®—æ€»è‚¾è¡¨ & æ€»æ’è¡¨</button>
            <div class="calculator-grid">
                <div class="calc-section">
                    <h3>æ€»è‚¾è¡¨</h3>
                    <div class="copy-button-container">
                        <button class="copy-button" onclick="copyToClipboard('total-bill-output', this)">ğŸ“‹ å¤åˆ¶</button>
                        <div id="total-bill-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>
                    </div>
                </div>
                <div class="calc-section">
                    <h3>æ€»æ’è¡¨</h3>
                    <div class="copy-button-container">
                        <button class="copy-button" onclick="copyToClipboard('total-items-output', this)">ğŸ“‹ å¤åˆ¶</button>
                        <div id="total-items-output">ç‚¹å‡»æŒ‰é’®è®¡ç®—...</div>
                    </div>
                </div>

                <!-- QR Code Uploader Start -->
                <div class="calc-section">
                    <h3>è‚¾ç </h3>
                    <div id="qr-code-container">
                        <p id="qr-code-placeholder" onclick="document.getElementById('qr-code-input').click()">
                            è¯·åœ¨è¿™é‡Œä¼ è‚¾ç å–µâ‚â‚ á••(Â´ Ï‰` )á•—â¾â¾</p>
                        <div id="qr-image-preview-container"></div>
                    </div>
                    <input type="file" id="qr-code-input" accept="image/*" multiple onchange="handleQrCodeUpload(event)"
                        style="display: none;">
                    <button onclick="document.getElementById('qr-code-input').click()">ä¸Šä¼ å›¾ç‰‡</button>
                    <button id="clear-qr-codes-btn" onclick="clearQrCodes()"
                        style="display: none; background-color: var(--accent-color);">æ¸…ç©ºå›¾ç‰‡</button>
                </div>
                <!-- QR Code Uploader End -->
                <div class="calc-section full-width">
                    <h3>è‚¾é¢æ ¸å¯¹</h3>
                    <div id="check-total-output">
                        <p>åº”å½“æ”¶è‚¾ (æŠ˜åæ€»é¢+ç‰¹å…¸æ€»ä»·å€¼): <span id="expected-total" class="result-field">0.00</span> å…ƒ</p>
                        <p>å®é™…æ”¶è‚¾ (å›¢å‘˜æ€»è®¡): <span id="actual-total" class="result-field">0.00</span> å…ƒ</p>
                        <p id="check-diff" class="info-text"></p>
                    </div>
                </div>
            </div>
        </section>

        <p class="footer-credit">All by Keichi & Gemini</p>

        <div id="export-options-modal">
            <h3>é€‰æ‹©å¯¼å‡ºå†…å®¹ (Excel)</h3>
            <button class="modal-button" onclick="exportCalculatorData(); hideExportOptions();">å¯¼å‡ºâ‘ è®¡ç®—å™¨</button>
            <button class="modal-button" onclick="exportTablesData(); hideExportOptions();">å¯¼å‡ºâ‘¡æ’è¡¨</button>
            <button class="modal-button" onclick="exportSummaryData(); hideExportOptions();">å¯¼å‡ºâ‘¢è‚¾è¡¨</button>
            <button class="modal-button" onclick="exportAllData(); hideExportOptions();">å¯¼å‡ºå…¨éƒ¨</button>
            <button class="modal-button cancel-button" onclick="hideExportOptions();">å–æ¶ˆ</button>
        </div>

        <div id="data-sync-modal">
            <h3>æ•°æ®äº’é€š</h3>
            <button class="modal-button" onclick="exportAllDataAsJson(); hideDataSyncModal();">å¯¼å‡ºå…¨éƒ¨æ•°æ® (JSON)</button>
            <input type="file" id="json-import-file" accept=".json" style="display: none;"
                onchange="handleJsonFileImport(event)">
            <button class="modal-button" onclick="document.getElementById('json-import-file').click();">å¯¼å…¥æ•°æ®
                (JSON)</button>
            <button class="modal-button cancel-button" onclick="hideDataSyncModal();">å–æ¶ˆ</button>
        </div>

        <div id="load-modal">
            <h3>é€‰æ‹©è¦è¯»å–çš„æ¡£æ¡ˆ</h3>
            <div id="load-modal-list">
                <!-- Archive list will be generated here -->
            </div>
            <button class="modal-button cancel-button" onclick="hideLoadModal()">å–æ¶ˆ</button>
        </div>

    </div>

    <script>
        let lastOrderPlan = null;
        const SAVE_MANIFEST_KEY = 'keichiToolSaves-v1.2';
        const ACTIVE_SLOT_KEY = 'keichiToolActiveSlot-v1.2';
        const DEFAULT_SLOT_NAME = 'é»˜è®¤å­˜æ¡£';
        const LAST_AUTO_SAVE_TIME_KEY_PREFIX = 'keichiToolLastAutoSave-v1.2_';
        const QR_CODES_KEY = 'keichiToolQrCodes-v1.2';
        let currentSlotName = DEFAULT_SLOT_NAME;
        let dynamicItemCounter = 0;
        let lastAutoSaveTimestamp = null;

        let itemTypes = {
            'postcard': {
                id_prefix: 'postcard', key: 'çš®è‚¤æ˜ä¿¡ç‰‡',
                defaults: { name: 'çš®è‚¤æ˜ä¿¡ç‰‡', price: 28, chars: 7, sets: 0 },
                avgPriceId: 'final-postcard-price',
                hasChars: true, hasSets: true, isDynamic: false, isSticker: false, setsLabel: 'é…æ•°'
            },
            'resume': {
                id_prefix: 'resume', key: 'äººäº‹éƒ¨ç®€å†',
                defaults: { name: 'äººäº‹éƒ¨ç®€å†', price: 24, chars: 3, sets: 0 },
                avgPriceId: 'final-resume-price',
                hasChars: true, hasSets: true, isDynamic: false, isSticker: false, setsLabel: 'é…æ•°'
            },
            'pass1': {
                id_prefix: 'pass1', key: 'é€šè¡Œè¯A',
                defaults: { name: 'é€šè¡Œè¯A', price: 350, chars: 7, sets: 0 },
                avgPriceId: 'final-pass1-price',
                hasChars: true, hasSets: true, setsLabel: 'ç›’æ•°', isDynamic: false, isSticker: false
            },
            'pass2': {
                id_prefix: 'pass2', key: 'é€šè¡Œè¯B',
                defaults: { name: 'é€šè¡Œè¯B', price: 350, chars: 7, sets: 0 },
                avgPriceId: 'final-pass2-price',
                hasChars: true, hasSets: true, setsLabel: 'ç›’æ•°', isDynamic: false, isSticker: false
            },
            'sticker': {
                id_prefix: 'sticker', key: 'è´´çº¸',
                defaults: { name: 'è´´çº¸', price: 20, chars: 8, sets: 0 },
                avgPriceId: 'final-sticker-pair-price',
                hasChars: true, hasSets: true, setsLabel: 'åŒ…æ•°', isSticker: true, isDynamic: false
            },
            'single': { id_prefix: 'single', key: 'å•é¢†', isDynamicTabContent: true, isDynamic: false },
            'bonus': { id_prefix: 'bonus', key: 'ç‰¹å…¸', isDynamicTabContent: true, canSplit: true, isDynamic: false }
        };
        const initialItemTypes = JSON.parse(JSON.stringify(itemTypes));
        let orderedTypesForTabs = ['postcard', 'resume', 'pass1', 'pass2', 'sticker', 'single', 'bonus'];


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('main-title').textContent = `å¼€è°·é›†æˆä¸€ä½“æœº ğŸ’–`;
            document.getElementById('version-info').textContent = `v1.2`;

            currentSlotName = localStorage.getItem(ACTIVE_SLOT_KEY) || DEFAULT_SLOT_NAME;
            document.getElementById('current-slot-display').textContent = `å½“å‰å­˜æ¡£: ${currentSlotName}`;

            updateLastAutoSaveTimeDisplay();

            loadData();
            loadQrCodes();
            showTab('calculator-section');
            if (document.getElementById('tables-section').classList.contains('active') && orderedTypesForTabs.length > 0) {
                const firstValidTab = orderedTypesForTabs.find(key => itemTypes[key]);
                if (firstValidTab) showItemTab(firstValidTab);
            }

            setInterval(() => {
                saveData(true);
            }, 1000); // Auto-save every 1 second

            window.addEventListener('beforeunload', () => saveData(true, false)); // Auto-save on refresh/close, no feedback

            // Tooltip functionality
            const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
            let activeTooltip = null;

            tooltipTriggers.forEach(trigger => {
                trigger.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const tooltipId = trigger.dataset.tooltipTarget;
                    const tooltip = document.getElementById(tooltipId);

                    if (activeTooltip && activeTooltip !== tooltip) {
                        activeTooltip.style.display = 'none';
                    }

                    if (tooltip) {
                        if (tooltip.style.display === 'block') {
                            tooltip.style.display = 'none';
                            activeTooltip = null;
                        } else {
                            tooltip.style.display = 'block';
                            const triggerRect = trigger.getBoundingClientRect();
                            const containerRect = document.querySelector('.container').getBoundingClientRect();

                            let top = triggerRect.bottom + window.scrollY + 5;
                            let left = triggerRect.left + window.scrollX;

                            tooltip.style.top = top + 'px';
                            tooltip.style.left = left + 'px';

                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (tooltipRect.right > window.innerWidth - 10) {
                                left = window.innerWidth - tooltipRect.width - 10 - window.scrollX;
                            }
                            if (left < 10) {
                                left = 10;
                            }
                            tooltip.style.left = left + 'px';

                            if (tooltipRect.bottom > window.innerHeight - 10 && triggerRect.top > tooltipRect.height + 5) {
                                top = triggerRect.top + window.scrollY - tooltipRect.height - 5;
                                tooltip.style.top = top + 'px';
                            }

                            activeTooltip = tooltip;
                        }
                    }
                });
            });

            document.addEventListener('click', (event) => {
                if (activeTooltip) {
                    const triggerForActiveTooltip = document.querySelector(`.tooltip-trigger[data-tooltip-target="${activeTooltip.id}"]`);
                    if (!activeTooltip.contains(event.target) && (!triggerForActiveTooltip || !triggerForActiveTooltip.contains(event.target))) {
                        activeTooltip.style.display = 'none';
                        activeTooltip = null;
                    }
                }
            });

            const finalDiscountTooltip = document.getElementById('final-discount-tooltip');
            if (finalDiscountTooltip) {
                finalDiscountTooltip.innerHTML = `
            <p style="margin-top:0;"><strong>â€œæœ€ç»ˆæŠ˜æ‰£â€æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ</strong></p>
            <p>ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯æ ¹æ®æ‚¨å®é™…æ”¯ä»˜çš„æ€»é‡‘é¢ï¼ˆæ‰£é™¤ç‰¹å…¸ä»·å€¼åï¼‰ä¸å•†å“åŸä»·æ€»é¢çš„æ¯”ç‡ã€‚</p>
            <p>è®¡ç®—é¡ºåºå¤§è‡´å¦‚ä¸‹ï¼š</p>
            <ol>
                <li>ç®—å‡ºæ‰€æœ‰å•†å“çš„åŸä»·æ€»å’Œ (è¿™æ˜¯â€œæŠ˜å‰æ€»é¢â€)ã€‚</li>
                <li>ä¾æ¬¡åº”ç”¨æ‚¨å¡«å†™çš„å„ç§æŠ˜æ‰£ï¼š
                    <ul>
                        <li>â€œå¤‡ç”¨æŠ˜æ‰£â€(ä¾‹å¦‚0.98)</li>
                        <li>â€œæ¯æ»¡Xå‡Yâ€(å¹³å°åˆ¸)</li>
                        <li>â€œä¼˜æƒ åˆ¸â€(å¦‚æ»¡300-20)</li>
                        <li>â€œ88VIPæŠ˜æ‰£â€</li>
                        <li>â€œè´­ç‰©é‡‘æŠ˜æ‰£â€</li>
                    </ul>
                </li>
                <li>å¾—åˆ°ä¸€ä¸ªåˆæ­¥çš„å•†å“å®ä»˜æ¬¾ã€‚</li>
                <li>åŠ ä¸Šé¢„ä¼°çš„â€œæ€»é‚®è´¹â€ã€‚</li>
                <li>å‡å»æ‚¨è·å¾—çš„â€œç‰¹å…¸æ€»ä»·å€¼â€ã€‚</li>
                <li>è¿™å°±æ˜¯æœ€ç»ˆé¡µé¢ä¸Šæ˜¾ç¤ºçš„â€œæŠ˜åæ€»é¢â€ã€‚</li>
                <li>ç”¨è¿™ä¸ªâ€œæŠ˜åæ€»é¢â€é™¤ä»¥ç¬¬1æ­¥çš„â€œæŠ˜å‰æ€»é¢â€ï¼Œå°±å¾—åˆ°â€œæœ€ç»ˆæŠ˜æ‰£ç‡â€ã€‚</li>
            </ol>
            <p><em>å„ä¸ªå•†å“çš„â€œå‡ä»·â€å°±æ˜¯ç”¨è¿™ä¸ªæŠ˜æ‰£ç‡ä¹˜ä»¥å®ƒä»¬çš„åŸä»·ï¼ˆæˆ–æ¯ä»½åŸä»·ï¼‰å¾—åˆ°çš„ã€‚</em></p>
        `;
            }

            const orderPlanTooltip = document.getElementById('order-plan-tooltip');
            if (orderPlanTooltip) {
                orderPlanTooltip.innerHTML = `
            <p style="margin-top:0;"><strong>â€œä¸‹å•æ–¹æ¡ˆâ€æ˜¯æ ¹æ®ä»€ä¹ˆè§„åˆ’çš„ï¼Ÿ</strong></p>
            <p>è¿™ä¸ªæ–¹æ¡ˆçš„ç›®æ ‡æ˜¯å¸®æ‚¨è§„åˆ’å¦‚ä½•ç»„åˆè®¢å•ï¼Œä»¥ä¾¿åœ¨ä¹°åˆ°æ‰€æœ‰æƒ³è¦çš„ä¸œè¥¿çš„å‰æä¸‹ï¼š</p>
            <ul>
                <li>å°½å¯èƒ½å¤šåœ°æ‹¿åˆ°å„æ¡£ä½ç‰¹å…¸ã€‚</li>
                <li>å°½å¯èƒ½å°‘ä»˜é‚®è´¹ï¼Œæˆ–è€…è®©é‚®è´¹èŠ±å¾—å€¼ï¼ˆæ¯”å¦‚ä»˜äº†é‚®è´¹ä½†æ‹¿åˆ°äº†ä»·å€¼æ›´é«˜çš„ç‰¹å…¸ï¼‰ã€‚</li>
            </ul>
            <p>å®ƒä¼šè€ƒè™‘ï¼š</p>
            <ul>
                <li>æ‚¨è´­ä¹°çš„æ‰€æœ‰å•†å“å’Œå®ƒä»¬çš„ä»·æ ¼ã€‚</li>
                <li>åŒ…é‚®é—¨æ§›å’Œé‚®è´¹é‡‘é¢ã€‚</li>
                <li>å„æ¡£ç‰¹å…¸çš„è·å–æ¡ä»¶ï¼ˆæ»¡å¤šå°‘é’±ï¼‰å’Œä»·å€¼ã€‚</li>
            </ul>
            <p>è®¡ç®—æœºä¼šå°è¯•æŠŠå•†å“åˆ†æˆä¸åŒæ•°é‡çš„è®¢å•ï¼ˆæ¯”å¦‚1å•ã€2å•ã€3å•ç­‰ï¼‰ï¼Œå¹¶ä¸ºæ¯ç§åˆ†æ³•è®¡ç®—èƒ½è·å¾—çš„â€œå‡€æ”¶ç›Šâ€ï¼ˆç‰¹å…¸æ€»ä»·å€¼ - é‚®è´¹æ€»é¢ï¼‰ï¼Œç„¶åæ¨èå‡€æ”¶ç›Šæœ€é«˜çš„é‚£ç§æ–¹æ¡ˆã€‚</p>
            <p><em>è¯·æ³¨æ„ï¼šè¿™åªæ˜¯ä¸€ä¸ªåŸºäºå½“å‰è®¾ç½®çš„ç®—æ³•å»ºè®®ï¼Œå®é™…æƒ…å†µå¯èƒ½æ›´å¤æ‚ï¼ˆå¦‚åº—é“ºé™è´­ã€ç‰¹å®šå•†å“ç»„åˆä¼˜æƒ ç­‰ï¼‰ã€‚æœ€ç»ˆè¿˜è¯·æ‚¨æ ¹æ®å®é™…æƒ…å†µæ ¸å¯¹å’Œè°ƒæ•´ï¼</em></p>
        `;
            }
            setupAutocomplete();
            // æ–°å¢ï¼šå¤„ç†è‚¾ç å›¾ç‰‡ç‚¹å‡»æ˜¾ç¤º/éšè—åˆ é™¤æŒ‰é’®çš„é€»è¾‘
            document.addEventListener('click', (e) => {
                const clickedWrapper = e.target.closest('.qr-image-wrapper');

                // 1. éšè—æ‰€æœ‰å½“å‰æ­£æ˜¾ç¤ºç€åˆ é™¤æŒ‰é’®çš„å›¾ç‰‡
                document.querySelectorAll('.qr-image-wrapper.show-delete').forEach(activeWrapper => {
                    if (activeWrapper !== clickedWrapper) {
                        activeWrapper.classList.remove('show-delete');
                    }
                });

                // 2. å¦‚æœç‚¹å‡»çš„æ˜¯ä¸€ä¸ªå›¾ç‰‡åŒ…è£…å™¨ï¼ˆä½†ä¸æ˜¯åˆ é™¤æŒ‰é’®æœ¬èº«ï¼‰ï¼Œåˆ™åˆ‡æ¢å®ƒçš„æ˜¾ç¤ºçŠ¶æ€
                if (clickedWrapper && !e.target.classList.contains('qr-delete-button')) {
                    clickedWrapper.classList.toggle('show-delete');
                }
            });

        });

        function updateLastAutoSaveTimeDisplay() {
            const displayElement = document.getElementById('last-auto-save-time');
            const savedTimestampStr = localStorage.getItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName);

            if (savedTimestampStr) {
                lastAutoSaveTimestamp = new Date(savedTimestampStr);
            } else {
                lastAutoSaveTimestamp = null;
            }

            if (displayElement && lastAutoSaveTimestamp) {
                const timeString = lastAutoSaveTimestamp.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                displayElement.textContent = `ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: ${timeString}`;
            } else if (displayElement) {
                displayElement.textContent = 'ä¸Šæ¬¡è‡ªåŠ¨ä¿å­˜æ—¶é—´: å°šæœªè‡ªåŠ¨ä¿å­˜';
            }
        }

        function saveData(isAutoSave = false, showFeedback = true) {
            const data = {
                calculator: {},
                tables: {},
                itemConfigs: {},
                dynamicTypeKeys: [],
                orderedTypesForTabs: [...orderedTypesForTabs],
                dynamicItemCounter: dynamicItemCounter,
                qrCodes: []
            };

            data.calculator.extraDiscountValues = [];
            data.calculator.extraCouponValues = [];
            const calcInputs = document.querySelectorAll('#calculator-section input');
            calcInputs.forEach(input => {
                if (input.id) {
                    data.calculator[input.id] = (input.type === 'checkbox') ? input.checked : input.value;
                } else if (input.classList.contains('extra-discount-input')) {
                    data.calculator.extraDiscountValues.push(input.value);
                } else if (input.classList.contains('extra-coupon-input')) {
                    data.calculator.extraCouponValues.push(input.value);
                }
            });

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                if (!itemConfig.isDynamicTabContent) {
                    const defaultsToSave = itemConfig.defaults || {};
                    data.itemConfigs[typeKey] = {
                        name: defaultsToSave.name || itemConfig.key,
                        price: defaultsToSave.price || '',
                        chars: defaultsToSave.chars || '',
                        sets: defaultsToSave.sets || '',
                        isSticker: itemConfig.isSticker || false,
                        hasChars: itemConfig.hasChars === undefined ? true : itemConfig.hasChars,
                        hasSets: itemConfig.hasSets === undefined ? true : itemConfig.hasSets,
                        setsLabel: itemConfig.setsLabel || (itemConfig.hasSets ? (itemConfig.isSticker ? 'åŒ…æ•°' : (itemConfig.id_prefix.includes('pass') ? 'ç›’æ•°' : 'é…æ•°')) : '')
                    };
                }
                if (itemConfig.isDynamic) {
                    data.dynamicTypeKeys.push(typeKey);
                }
            });

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                const dataTableKey = itemConfig.key;
                data.tables[dataTableKey] = [];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                table.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = { distribution: [] };
                    let mainIdentifierFilled = false;
                    let distributionHasContent = false;

                    const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                    if (charNameInput && charNameInput.value.trim() !== '') {
                        rowData.charName = charNameInput.value.trim();
                        mainIdentifierFilled = true;
                    }
                    const kindInput = row.querySelector('input[data-type="kind"]');
                    if (kindInput && kindInput.value.trim() !== '') {
                        if (typeKey === 'bonus') rowData.tier = kindInput.value.trim();
                        else rowData.kind = kindInput.value.trim();
                        mainIdentifierFilled = true;
                    }
                    const customKindInput = row.querySelector('.custom-kind');
                    if (customKindInput && customKindInput.value.trim() !== '') {
                        rowData.customKind = customKindInput.value.trim();
                        mainIdentifierFilled = true;
                    }
                    const priceInputForSingle = row.querySelector('input[data-type="price"]');
                    if (priceInputForSingle && typeKey === 'single' && priceInputForSingle.value.trim() !== '') {
                        rowData.price = priceInputForSingle.value.trim();
                        mainIdentifierFilled = true;
                    }

                    const adjPriceInput = row.querySelector('.adj-price');
                    if (adjPriceInput) rowData.adjPrice = adjPriceInput.value;

                    const statusCell = row.querySelector('.sticker-status');
                    if (statusCell) rowData.status = statusCell.textContent;
                    rowData.splitCount = row.dataset.splitCount || 1;

                    const distEntriesOnPage = row.querySelectorAll('.dist-entry');
                    distEntriesOnPage.forEach(entry => {
                        const name = entry.querySelector('.dist-name').value;
                        const quantity = entry.querySelector('.dist-quantity').value;
                        if (name.trim() !== '' || quantity.trim() !== '') {
                            rowData.distribution.push({ name, quantity });
                            if (name.trim() !== '' || (quantity.trim() !== '' && parseInt(quantity) !== 0)) {
                                distributionHasContent = true;
                            }
                        } else if (distEntriesOnPage.length === 1 && name.trim() === '' && quantity.trim() === '') {
                            rowData.distribution.push({ name: '', quantity: '' });
                        }
                    });

                    if (itemConfig && !itemConfig.isDynamicTabContent && itemConfig.hasChars && !itemConfig.isDynamic) {
                        data.tables[dataTableKey].push(rowData);
                    }
                    else if (mainIdentifierFilled || distributionHasContent || (rowData.adjPrice && parseFloat(rowData.adjPrice) !== 0)) {
                        data.tables[dataTableKey].push(rowData);
                    }
                    else if (typeKey === 'bonus' && rowData.tier &&
                        (rowData.tier.includes('ä¸€æ¡£') || rowData.tier.includes('äºŒæ¡£') || rowData.tier.includes('ä¸‰æ¡£')) &&
                        !mainIdentifierFilled && !distributionHasContent && (!rowData.adjPrice || parseFloat(rowData.adjPrice) === 0)) {
                        data.tables[dataTableKey].push(rowData);
                    }
                });
            });

            // Save QR Codes
            const qrImages = document.querySelectorAll('#qr-image-preview-container img');
            qrImages.forEach(img => {
                if (img.src) {
                    data.qrCodes.push(img.src);
                }
            });

            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            allSaves[currentSlotName] = data;
            localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));

            if (isAutoSave) {
                lastAutoSaveTimestamp = new Date();
                localStorage.setItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName, lastAutoSaveTimestamp.toISOString());
                updateLastAutoSaveTimeDisplay();
            }
        }

        function archiveData() {
            const defaultName = getFormattedDateTime();
            const newSlotName = prompt(`è¯·è¾“å…¥æ¡£æ¡ˆåç§°ï¼ˆç”¨äºåœ¨è¯»å–æ—¶è¯†åˆ«ï¼‰`, defaultName);

            if (newSlotName && newSlotName.trim() !== '') {
                currentSlotName = newSlotName.trim();
                localStorage.setItem(ACTIVE_SLOT_KEY, currentSlotName);
                document.getElementById('current-slot-display').textContent = `å½“å‰å­˜æ¡£: ${currentSlotName}`;

                saveData(false); // Save the current state to this new slot name

                const archiveBtn = document.getElementById('archive-button');
                archiveBtn.textContent = 'âœ… å­˜å‚¨æˆåŠŸ!';
                setTimeout(() => { archiveBtn.textContent = 'ğŸ’¾ å­˜å‚¨æ¡£æ¡ˆ'; }, 2000);
            }
        }

        function loadData(importedData = null) {
            let dataToLoad = null;

            if (importedData) {
                dataToLoad = importedData;
            } else {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
                dataToLoad = allSaves[currentSlotName];
            }

            // å¦‚æœæ²¡æœ‰æ•°æ®å¯åŠ è½½ (æ¯”å¦‚é‡ç½®æˆ–æ–°å­˜æ¡£)ï¼Œåˆ™å½»åº•æ¢å¤åˆ°åˆå§‹çŠ¶æ€
            if (!dataToLoad) {
                itemTypes = JSON.parse(JSON.stringify(initialItemTypes));
            }

            clearDynamicItemTypesAndUI();
            dynamicItemCounter = 0;

            if (dataToLoad) {
                dynamicItemCounter = dataToLoad.dynamicItemCounter || 0;

                if (dataToLoad.orderedTypesForTabs) {
                    orderedTypesForTabs = [...dataToLoad.orderedTypesForTabs];
                } else {
                    orderedTypesForTabs = ['postcard', 'resume', 'pass1', 'pass2', 'sticker', 'single', 'bonus'];
                }

                if (dataToLoad.itemConfigs) {
                    Object.keys(dataToLoad.itemConfigs).forEach(typeKey => {
                        const config = dataToLoad.itemConfigs[typeKey];
                        if (itemTypes[typeKey] && !itemTypes[typeKey].isDynamic) {
                            itemTypes[typeKey].key = config.name;
                            itemTypes[typeKey].defaults = { name: config.name, price: config.price, chars: config.chars, sets: config.sets };
                            if (config.isSticker !== undefined) itemTypes[typeKey].isSticker = config.isSticker;
                            if (config.hasChars !== undefined) itemTypes[typeKey].hasChars = config.hasChars;
                            if (config.hasSets !== undefined) itemTypes[typeKey].hasSets = config.hasSets;
                            if (config.setsLabel !== undefined) itemTypes[typeKey].setsLabel = config.setsLabel;

                        } else if (dataToLoad.dynamicTypeKeys && dataToLoad.dynamicTypeKeys.includes(typeKey)) {
                            itemTypes[typeKey] = {
                                id_prefix: typeKey,
                                key: config.name,
                                defaults: { name: config.name, price: config.price, chars: config.chars, sets: config.sets },
                                avgPriceId: `final-${typeKey}-price`,
                                hasChars: config.hasChars !== undefined ? config.hasChars : true,
                                hasSets: config.hasSets !== undefined ? config.hasSets : true,
                                setsLabel: config.setsLabel || (config.hasSets ? 'é…æ•°' : ''),
                                isSticker: config.isSticker || false,
                                isDynamic: true,
                                isDynamicTabContent: false
                            };
                        }
                    });
                }

            } else {
                orderedTypesForTabs = ['postcard', 'resume', 'pass1', 'pass2', 'sticker', 'single', 'bonus'];
            }

            orderedTypesForTabs = orderedTypesForTabs.filter(typeKey => itemTypes[typeKey]);

            const staticTypes = ['postcard', 'resume', 'pass1', 'pass2', 'sticker', 'single', 'bonus'];
            staticTypes.forEach(st => {
                if (itemTypes[st] && !orderedTypesForTabs.includes(st)) {
                    const singleIndex = orderedTypesForTabs.indexOf('single');
                    if (singleIndex !== -1) {
                        orderedTypesForTabs.splice(singleIndex, 0, st);
                    } else {
                        orderedTypesForTabs.push(st);
                    }
                }
            });
            orderedTypesForTabs = [...new Set(orderedTypesForTabs)];

            generateTables(dataToLoad ? dataToLoad.tables : null);

            if (dataToLoad && dataToLoad.calculator) {
                document.querySelectorAll('#calculator-section input:not(.extra-discount-input):not(.extra-coupon-input)').forEach(input => {
                    if (input.id && dataToLoad.calculator[input.id] !== undefined) {
                        input.type === 'checkbox' ? input.checked = dataToLoad.calculator[input.id] : input.value = dataToLoad.calculator[input.id];
                    } else if (input.type !== 'checkbox') {
                        input.value = input.defaultValue || '';
                    } else {
                        input.checked = input.defaultChecked || false;
                    }
                });

                if (document.getElementById('enable-bonus3').checked) {
                    document.getElementById('bonus3-section').style.display = 'block';
                    document.getElementById('bonus3-manual-section').style.display = 'block';
                } else {
                    document.getElementById('bonus3-section').style.display = 'none';
                    document.getElementById('bonus3-manual-section').style.display = 'none';
                }

                const extraDiscountsContainer = document.getElementById('extra-discounts');
                extraDiscountsContainer.innerHTML = '';
                if (dataToLoad.calculator.extraDiscountValues && Array.isArray(dataToLoad.calculator.extraDiscountValues)) {
                    dataToLoad.calculator.extraDiscountValues.forEach(value => {
                        addExtraDiscount(false);
                        const allExtraDiscountInputs = extraDiscountsContainer.querySelectorAll('.extra-discount-input');
                        const newDiscountInput = allExtraDiscountInputs[allExtraDiscountInputs.length - 1];
                        if (newDiscountInput) newDiscountInput.value = value;
                    });
                }

                const extraCouponsContainer = document.getElementById('extra-coupons');
                extraCouponsContainer.innerHTML = '';
                if (dataToLoad.calculator.extraCouponValues && Array.isArray(dataToLoad.calculator.extraCouponValues)) {
                    dataToLoad.calculator.extraCouponValues.forEach(value => {
                        addExtraCoupon(false);
                        const allExtraCouponInputs = extraCouponsContainer.querySelectorAll('.extra-coupon-input');
                        const newCouponInput = allExtraCouponInputs[allExtraCouponInputs.length - 1];
                        if (newCouponInput) newCouponInput.value = value;
                    });
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ•°æ®åŠ è½½ï¼Œæ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
                document.querySelectorAll('#calculator-section input').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.type === 'number' || input.type === 'text') {
                        input.value = '';
                    }
                });
                document.getElementById('extra-discounts').innerHTML = '';
                document.getElementById('extra-coupons').innerHTML = '';
                toggleBonus3();
            }

            calculateAll();
            calculateSummary();

            if (importedData || !dataToLoad) {
                saveData(true);
            }

            updateNameCaches();
        }

        function clearDynamicItemTypesAndUI() {
            Object.keys(itemTypes).forEach(typeKey => {
                if (itemTypes[typeKey] && itemTypes[typeKey].isDynamic) {
                    delete itemTypes[typeKey];
                }
            });
            orderedTypesForTabs = orderedTypesForTabs.filter(typeKey => itemTypes[typeKey] && !itemTypes[typeKey].isDynamic);

            document.getElementById('dynamic-items-opening-display').innerHTML = '';
            document.getElementById('dynamic-items-final-discount-display').innerHTML = '';
        }

        function resetCurrentSlotData() {
            if (confirm(`ç¡®å®šè¦é‡ç½®å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');

                if (allSaves[currentSlotName]) {
                    delete allSaves[currentSlotName];
                    localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));
                }

                localStorage.removeItem(LAST_AUTO_SAVE_TIME_KEY_PREFIX + currentSlotName);

                // ä¸å†åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨loadData(null)æ¥é‡ç½®åº”ç”¨çŠ¶æ€
                loadData(null);

                updateLastAutoSaveTimeDisplay(); // æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´

                alert('å½“å‰å­˜æ¡£æ•°æ®å·²é‡ç½®ï¼');
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        function showItemTab(tabKeyToShow) {
            document.querySelectorAll('.item-tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.item-tab-button').forEach(b => b.classList.remove('active'));

            const tabContent = document.getElementById(`table-${tabKeyToShow}`);
            if (tabContent) tabContent.style.display = 'block';

            const tabButton = document.querySelector(`.item-tab-button[data-tab="${tabKeyToShow}"]`);
            if (tabButton) tabButton.classList.add('active');
        }

        function toggleBonus3() {
            const isEnabled = document.getElementById('enable-bonus3').checked;
            document.getElementById('bonus3-section').style.display = isEnabled ? 'block' : 'none';
            document.getElementById('bonus3-manual-section').style.display = isEnabled ? 'block' : 'none';
        }

        function addExtraDiscount() {
            const container = document.getElementById('extra-discounts');
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
        <label>å¤‡ç”¨æŠ˜æ‰£ (ä¸å¡«ä¸º1ï¼Œä¼˜å…ˆè®¡ç®—)</label> 
        <input type="number" class="extra-discount-input" placeholder="ä¾‹å¦‚: 0.98" step="0.01">
        <button type="button" class="remove-btn-text" onclick="this.parentElement.remove();">Ã—</button>
    `;
            container.appendChild(div);
        }

        function addExtraCoupon() {
            const container = document.getElementById('extra-coupons');
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
        <label>å¤‡ç”¨åˆ¸é¢é¢ (å…ƒ)</label> 
        <input type="number" class="extra-coupon-input" placeholder="ä¾‹å¦‚: 10" step="1">
        <button type="button" class="remove-btn-text" onclick="this.parentElement.remove();">Ã—</button>
    `;
            container.appendChild(div);
        }

        function handleQrCodeUpload(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('qr-image-preview-container');
            const placeholder = document.getElementById('qr-code-placeholder');
            const clearBtn = document.getElementById('clear-qr-codes-btn');

            if (!files || files.length === 0) return;

            const readPromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) continue;

                const promise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
                readPromises.push(promise);
            }

            Promise.all(readPromises).then(results => {
                results.forEach(src => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'qr-image-wrapper';

                    const img = document.createElement('img');
                    img.src = src;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'qr-delete-button';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.onclick = () => {
                        wrapper.remove();
                        saveQrCodes();
                        if (previewContainer.children.length === 0) {
                            placeholder.style.display = 'block';
                            clearBtn.style.display = 'none';
                        }
                    };

                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    previewContainer.appendChild(wrapper);
                });

                if (previewContainer.children.length > 0) {
                    placeholder.style.display = 'none';
                    clearBtn.style.display = 'inline-block';
                }

                saveQrCodes();
            }).catch(error => {
                console.error("Error reading files:", error);
                alert("è¯»å–å›¾ç‰‡æ–‡ä»¶æ—¶å‡ºé”™ã€‚");
            });

            event.target.value = '';
        }

        function clearQrCodes() {
            const previewContainer = document.getElementById('qr-image-preview-container');
            const placeholder = document.getElementById('qr-code-placeholder');
            const clearBtn = document.getElementById('clear-qr-codes-btn');

            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‚¾ç å›¾ç‰‡å—ï¼Ÿ')) {
                previewContainer.innerHTML = '';
                placeholder.style.display = 'block';
                clearBtn.style.display = 'none';
                saveQrCodes();
            }
        }

        function saveQrCodes() {
            const qrImages = document.querySelectorAll('#qr-image-preview-container img');
            const qrCodes = [];
            qrImages.forEach(img => {
                if (img.src) {
                    qrCodes.push(img.src);
                }
            });
            localStorage.setItem(QR_CODES_KEY, JSON.stringify(qrCodes));
        }

        function loadQrCodes() {
            const savedQrCodes = localStorage.getItem(QR_CODES_KEY);
            if (!savedQrCodes) return;

            const qrCodes = JSON.parse(savedQrCodes);
            const previewContainer = document.getElementById('qr-image-preview-container');
            const placeholder = document.getElementById('qr-code-placeholder');
            const clearBtn = document.getElementById('clear-qr-codes-btn');

            previewContainer.innerHTML = '';

            qrCodes.forEach(src => {
                const wrapper = document.createElement('div');
                wrapper.className = 'qr-image-wrapper';

                const img = document.createElement('img');
                img.src = src;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'qr-delete-button';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = () => {
                    wrapper.remove();
                    saveQrCodes();
                    if (previewContainer.children.length === 0) {
                        placeholder.style.display = 'block';
                        clearBtn.style.display = 'none';
                    }
                };

                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                previewContainer.appendChild(wrapper);
            });

            if (previewContainer.children.length > 0) {
                placeholder.style.display = 'none';
                clearBtn.style.display = 'inline-block';
            }
        }


        function getInputs() {
            const getNum = id => parseFloat(document.getElementById(id).value) || 0;
            const getVal = id => document.getElementById(id).value;
            const getDiscount = id => parseFloat(document.getElementById(id).value) || 1;
            let extraDiscounts = Array.from(document.querySelectorAll('.extra-discount-input')).map(input => parseFloat(input.value) || 1);
            let extraCoupons = Array.from(document.querySelectorAll('.extra-coupon-input')).map(input => parseFloat(input.value) || 0);

            const inputs = {
                bonus1: { value: getNum('bonus1-value'), manual_count: getVal('bonus1-count-manual') },
                bonus2: { threshold: getNum('bonus2-threshold'), value: getNum('bonus2-value'), manual_count: getVal('bonus2-count-manual') },
                bonus3: { enabled: document.getElementById('enable-bonus3').checked, threshold: getNum('bonus3-threshold'), value: getNum('bonus3-value'), manual_count: getVal('bonus3-count-manual') },
                manjian: { threshold: getNum('manjian-threshold'), value: getNum('manjian-value') },
                vipDiscount: getDiscount('vip-discount'),
                goldDiscount: getDiscount('gold-discount'),
                extraDiscounts: extraDiscounts,
                coupons: { c300_20: getNum('coupon-300-20'), c200_10: getNum('coupon-200-10'), extra: extraCoupons.reduce((a, b) => a + b, 0) },
                shipping: { threshold: getNum('free-shipping-threshold'), fee: getNum('shipping-fee') }
            };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig.isDynamicTabContent) {
                    const currentDefaults = itemConfig.defaults || {};
                    inputs[typeKey] = {
                        name: currentDefaults.name || itemConfig.key,
                        price: parseFloat(currentDefaults.price) || 0,
                        chars: parseInt(currentDefaults.chars) || 0,
                        sets: parseInt(currentDefaults.sets) || 0,
                    };
                }
            });
            return inputs;
        }

        function updateItemConfigAndRecalculate(typeKeyChanged) {
            const itemConfig = itemTypes[typeKeyChanged];
            if (!itemConfig) return;
            const idPrefix = itemConfig.id_prefix;

            const nameInput = document.getElementById(`item-name-${idPrefix}`);
            const priceInput = document.getElementById(`item-price-${idPrefix}`);
            const charsInput = document.getElementById(`item-chars-${idPrefix}`);
            const setsInput = document.getElementById(`item-sets-${idPrefix}`);

            if (!itemConfig.defaults) itemConfig.defaults = {};

            if (nameInput) {
                const newName = nameInput.value || (itemConfig.defaults.name || itemConfig.key);
                itemConfig.key = newName;
                itemConfig.defaults.name = newName;
            }
            if (priceInput) {
                itemConfig.defaults.price = priceInput.value;
            }
            if (charsInput) {
                itemConfig.defaults.chars = charsInput.value;
            }
            if (setsInput) {
                itemConfig.defaults.sets = setsInput.value;
            }

            updateCalculatorDisplay();
        }

        function updateCalculatorDisplay() {
            const dynamicOpeningDisplay = document.getElementById('dynamic-items-opening-display');
            const dynamicFinalDiscountDisplay = document.getElementById('dynamic-items-final-discount-display');
            dynamicOpeningDisplay.innerHTML = '';
            dynamicFinalDiscountDisplay.innerHTML = '';

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (itemConfig.isDynamicTabContent) return;

                const idPrefix = itemConfig.id_prefix;
                const currentName = itemConfig.key;

                const price = (itemConfig.defaults && itemConfig.defaults.price !== undefined) ? itemConfig.defaults.price : '';
                const sets = (itemConfig.defaults && itemConfig.defaults.sets !== undefined) ? itemConfig.defaults.sets : '';

                let priceDisplaySpan = document.getElementById(`${idPrefix}-price-display`);
                let priceLabel = document.getElementById(`${idPrefix}-price-label`);
                let setsDisplaySpan = document.getElementById(`${idPrefix}-sets-display`);
                let setsLabel = document.getElementById(`${idPrefix}-sets-label`);
                let hrElement;

                if (itemConfig.isDynamic) {
                    hrElement = dynamicOpeningDisplay.querySelector(`hr[data-prefix="${idPrefix}"]`);
                    if (!hrElement) {
                        hrElement = document.createElement('hr');
                        hrElement.dataset.prefix = idPrefix;
                        dynamicOpeningDisplay.appendChild(hrElement);
                    }

                    if (!priceLabel) {
                        const group1 = document.createElement('div');
                        group1.className = 'input-group';
                        priceLabel = document.createElement('label');
                        priceLabel.id = `${idPrefix}-price-label`;
                        priceDisplaySpan = document.createElement('span');
                        priceDisplaySpan.id = `${idPrefix}-price-display`;
                        priceDisplaySpan.className = 'display-field';
                        group1.appendChild(priceLabel);
                        group1.appendChild(priceDisplaySpan);
                        dynamicOpeningDisplay.appendChild(group1);
                    }
                    if (!setsLabel) {
                        const group2 = document.createElement('div');
                        group2.className = 'input-group';
                        setsLabel = document.createElement('label');
                        setsLabel.id = `${idPrefix}-sets-label`;
                        setsDisplaySpan = document.createElement('span');
                        setsDisplaySpan.id = `${idPrefix}-sets-display`;
                        setsDisplaySpan.className = 'display-field';
                        group2.appendChild(setsLabel);
                        group2.appendChild(setsDisplaySpan);
                        dynamicOpeningDisplay.appendChild(group2);
                    }
                }

                if (priceDisplaySpan) priceDisplaySpan.textContent = price;
                if (priceLabel) priceLabel.textContent = `${currentName} - ä»·æ ¼`;
                if (setsDisplaySpan) setsDisplaySpan.textContent = sets;
                if (setsLabel) setsLabel.textContent = `${currentName} - ${itemConfig.setsLabel || (itemConfig.hasSets ? 'é…æ•°' : '')}`;


                let finalPriceNameDisplay = document.getElementById(`final-${idPrefix}-name-display`);
                let finalPriceField = document.getElementById(itemConfig.avgPriceId);

                if (itemConfig.isDynamic) {
                    if (!finalPriceNameDisplay) {
                        const p = document.createElement('p');
                        finalPriceNameDisplay = document.createElement('span');
                        finalPriceNameDisplay.id = `final-${idPrefix}-name-display`;
                        finalPriceField = document.createElement('span');
                        finalPriceField.id = itemConfig.avgPriceId;
                        finalPriceField.className = 'result-field';
                        finalPriceField.textContent = '0.00';

                        p.appendChild(finalPriceNameDisplay);
                        p.append("å‡ä»·: ");
                        p.appendChild(finalPriceField);
                        p.append(" å…ƒ");
                        dynamicFinalDiscountDisplay.appendChild(p);
                    }
                }

                if (finalPriceNameDisplay) finalPriceNameDisplay.textContent = currentName;

                const tabButton = document.querySelector(`.item-tab-button[data-tab="${typeKey}"]`);
                if (tabButton) tabButton.textContent = `ã€${currentName}ã€‘`;

                const tableH3 = document.querySelector(`#table-${typeKey} h3`);
                if (tableH3) {
                    let tooltipSpan = tableH3.querySelector('.tooltip-trigger');
                    if (tooltipSpan) {
                        tableH3.childNodes[0].nodeValue = `${currentName} æ’è¡¨ `;
                    } else {
                        tableH3.textContent = `${currentName} æ’è¡¨`;
                    }
                }
            });
        }

        function handleCharacterCountChangeAndCalc(typeKeyChanged) {
            const itemConfig = itemTypes[typeKeyChanged];

            if (!itemConfig || itemConfig.isDynamicTabContent || !itemConfig.hasChars) {
                return;
            }

            const idPrefix = itemConfig.id_prefix;
            const tableBody = document.querySelector(`#data-table-${typeKeyChanged} tbody`);
            const charCountInput = document.getElementById(`item-chars-${idPrefix}`);
            const newCharCount = parseInt(charCountInput.value) || 0;

            if (itemConfig.defaults) {
                itemConfig.defaults.chars = newCharCount.toString();
            }

            if (!tableBody) {
                return;
            }
            const currentRows = Array.from(tableBody.rows);
            const currentRowCount = currentRows.length;

            if (newCharCount > currentRowCount) {
                for (let i = currentRowCount; i < newCharCount; i++) {
                    const newRow = tableBody.insertRow();
                    populateTableRow(newRow, typeKeyChanged, i, {});
                }
            } else if (newCharCount < currentRowCount) {
                let proceedWithRemoval = true;
                for (let i = currentRowCount - 1; i >= newCharCount; i--) {
                    let hasData = false;
                    currentRows[i].querySelectorAll('.dist-entry').forEach(entry => {
                        if (entry.querySelector('.dist-name').value.trim() ||
                            (parseInt(entry.querySelector('.dist-quantity').value) || 0) > 0) {
                            hasData = true;
                        }
                    });
                    const charNameInput = currentRows[i].querySelector('input[placeholder="è§’è‰²å..."]');
                    if (charNameInput && charNameInput.value.trim()) hasData = true;
                    const adjPriceInput = currentRows[i].querySelector('.adj-price');
                    if (adjPriceInput && (parseFloat(adjPriceInput.value) || 0) !== 0) hasData = true;


                    if (hasData) {
                        if (!confirm(`è§’è‰²"${charNameInput?.value || `è¡Œ ${i + 1}`}" çš„æ’è¡¨æˆ–è°ƒä»·æ•°æ®å°†è¢«åˆ é™¤ï¼Œç¡®å®šæ›´æ”¹è§’è‰²æ•°å—ï¼Ÿ`)) {
                            charCountInput.value = currentRowCount;
                            if (itemConfig.defaults) itemConfig.defaults.chars = currentRowCount.toString();
                            proceedWithRemoval = false;
                            break;
                        }
                    }
                }
                if (proceedWithRemoval) {
                    for (let i = currentRowCount - 1; i >= newCharCount; i--) {
                        tableBody.deleteRow(i);
                    }
                }
            }
        }

        function calculateAll() {
            updateCalculatorDisplay();
            const inputs = getInputs();

            const singleItemTotal = calculateSingleItemTotal();
            let mainItemsTotal = 0;
            Object.keys(itemTypes).forEach(typeKey => {
                const itemDef = itemTypes[typeKey];
                if (!itemDef.isDynamicTabContent && inputs[typeKey]) {
                    mainItemsTotal += inputs[typeKey].price * inputs[typeKey].sets;
                }
            });

            const pass1Data = inputs['pass1'];
            const pass2Data = inputs['pass2'];
            const passTotalVal = (pass1Data ? pass1Data.price * pass1Data.sets : 0) +
                (pass2Data ? pass2Data.price * pass2Data.sets : 0);

            const totalExcludingPass = mainItemsTotal - passTotalVal + singleItemTotal;
            const totalBeforeDiscount = mainItemsTotal + singleItemTotal;

            document.getElementById('single-item-total').textContent = singleItemTotal.toFixed(2);
            document.getElementById('total-excluding-pass').textContent = totalExcludingPass.toFixed(2);
            document.getElementById('total-before-discount').textContent = totalBeforeDiscount.toFixed(2);

            let allItems = [];
            let itemId = 0;
            const addItemToList = (name, price, count) => {
                for (let i = 0; i < count; i++) {
                    if (price > 0) allItems.push({ id: itemId++, name, price });
                }
            };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemDef = itemTypes[typeKey];
                if (!itemDef.isDynamicTabContent && inputs[typeKey]) {
                    addItemToList(inputs[typeKey].name, inputs[typeKey].price, inputs[typeKey].sets);
                }
            });

            document.querySelectorAll('#data-table-single tbody tr').forEach(row => {
                const name = row.querySelector('input[data-type="kind"]').value;
                const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                const totalQty = Object.values(getDistributionFromInputs(row)).reduce((a, b) => a + b, 0);
                addItemToList(`å•é¢†-${name}`, price, totalQty);
            });

            lastOrderPlan = calculateOrderPlan(allItems, inputs);
            displayOrderPlan(lastOrderPlan, inputs);

            let totalBonusValueForDiscount = 0;
            if (inputs.bonus1.manual_count !== '' && inputs.bonus1.manual_count !== null) {
                totalBonusValueForDiscount += parseFloat(inputs.bonus1.manual_count) * inputs.bonus1.value;
            } else {
                totalBonusValueForDiscount += lastOrderPlan.bonusCounts[1] * inputs.bonus1.value;
            }
            if (inputs.bonus2.manual_count !== '' && inputs.bonus2.manual_count !== null) {
                totalBonusValueForDiscount += parseFloat(inputs.bonus2.manual_count) * inputs.bonus2.value;
            } else {
                totalBonusValueForDiscount += lastOrderPlan.bonusCounts[2] * inputs.bonus2.value;
            }
            if (inputs.bonus3.enabled && inputs.bonus3.manual_count !== '' && inputs.bonus3.manual_count !== null) {
                totalBonusValueForDiscount += parseFloat(inputs.bonus3.manual_count) * inputs.bonus3.value;
            } else if (inputs.bonus3.enabled) {
                totalBonusValueForDiscount += lastOrderPlan.bonusCounts[3] * inputs.bonus3.value;
            }
            document.getElementById('bonus-total-value').textContent = totalBonusValueForDiscount.toFixed(2);

            let currentPrice = totalBeforeDiscount;
            const manjianReductionAmount = (inputs.manjian.threshold > 0 && totalBeforeDiscount >= inputs.manjian.threshold && inputs.manjian.value > 0)
                ? Math.floor(totalBeforeDiscount / inputs.manjian.threshold) * inputs.manjian.value
                : 0;
            let extraDiscountMultiplier = 1;
            inputs.extraDiscounts.forEach(d => extraDiscountMultiplier *= d);
            currentPrice = currentPrice * extraDiscountMultiplier;
            currentPrice = currentPrice - manjianReductionAmount;
            const totalCouponDiscount = (inputs.coupons.c300_20 * 20) + (inputs.coupons.c200_10 * 10) + inputs.coupons.extra;
            currentPrice = currentPrice - totalCouponDiscount;
            currentPrice = currentPrice * inputs.vipDiscount;
            currentPrice = currentPrice * inputs.goldDiscount;
            currentPrice = Math.max(0, currentPrice);
            currentPrice = Math.ceil(currentPrice * 100) / 100;

            const totalAfterDiscountResult = currentPrice + lastOrderPlan.totalShippingFee - totalBonusValueForDiscount;

            document.getElementById('total-after-discount').textContent = totalAfterDiscountResult.toFixed(2);
            const finalDiscountRate = totalBeforeDiscount > 0 ? totalAfterDiscountResult / totalBeforeDiscount : 1;
            document.getElementById('final-discount-rate').textContent = totalBeforeDiscount > 0 ? finalDiscountRate.toFixed(4) : 'N/A';

            updateFinalPrices(finalDiscountRate, inputs);
            updateBonusGapInfo(totalBeforeDiscount, inputs, lastOrderPlan);
            updateAllTablePrices();
        }

        function calculateSingleItemTotal() {
            let total = 0;
            const singleTableBody = document.querySelector('#data-table-single tbody');
            if (singleTableBody) {
                singleTableBody.querySelectorAll('tr').forEach(row => {
                    const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                    const distribution = getDistributionFromInputs(row);
                    const quantity = Object.values(distribution).reduce((sum, q) => sum + q, 0);
                    total += price * quantity;
                });
            }
            return total;
        }

        function updateFinalPrices(finalDiscountRate, inputs) {
            if (finalDiscountRate === 'N/A' || isNaN(finalDiscountRate)) finalDiscountRate = 1.0;
            const ceil2 = val => Math.ceil(val * 100) / 100;

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                if (itemConfig.isDynamicTabContent || !inputs[typeKey]) return;

                const itemData = inputs[typeKey];
                const avgPriceId = itemConfig.avgPriceId;

                const finalPriceField = document.getElementById(avgPriceId);
                if (!finalPriceField) {
                    return;
                }

                if (itemConfig.isSticker) {
                    const stickerSingleAvg = (itemData.price / 16) * finalDiscountRate;
                    const stickerPairAvg = (itemData.price / 8) * finalDiscountRate;
                    document.getElementById('final-sticker-single-price').textContent = ceil2(stickerSingleAvg).toFixed(2);
                    finalPriceField.textContent = ceil2(stickerPairAvg).toFixed(2);
                } else {
                    const avgPrice = itemData.chars > 0 ? (itemData.price / itemData.chars) * finalDiscountRate : 0;
                    finalPriceField.textContent = ceil2(avgPrice).toFixed(2);
                }
            });
        }

        function calculateOrderPlan(items, inputs) {
            if (items.length === 0) {
                return { orders: [], totalBonusValue: 0, totalShippingFee: 0, bonusCounts: { 1: 0, 2: 0, 3: 0 }, isolatedOrderInfo: null };
            }

            const getBonusInfoForAmount = (amount) => {
                let bonus = { value: 0, tiers: [], highest_tier: 0 };
                if (inputs.bonus3.enabled && inputs.bonus3.threshold > 0 && amount >= inputs.bonus3.threshold) {
                    bonus.value += inputs.bonus3.value; bonus.tiers.push(3); bonus.highest_tier = 3;
                }
                if (inputs.bonus2.threshold > 0 && amount >= inputs.bonus2.threshold) {
                    bonus.value += inputs.bonus2.value; bonus.tiers.push(2);
                    if (bonus.highest_tier < 2) bonus.highest_tier = 2;
                }
                if (amount > 0.001 && inputs.bonus1.value > 0) {
                    bonus.value += inputs.bonus1.value; bonus.tiers.push(1);
                    if (bonus.highest_tier < 1) bonus.highest_tier = 1;
                }
                bonus.tiers = [...new Set(bonus.tiers)].sort((a, b) => a - b);
                return bonus;
            };
            const getShipping = (amount) => (inputs.shipping.threshold > 0 && amount > 0.001 && amount < inputs.shipping.threshold) ? inputs.shipping.fee : 0;
            const getNetBenefit = (orderTotal) => getBonusInfoForAmount(orderTotal).value - getShipping(orderTotal);
            const getNetBenefitForOrderList = (orderList) => orderList.reduce((sum, order) => sum + getNetBenefit(order.total), 0);

            const solveForKOrders = (k, currentItems) => {
                let orders = Array.from({ length: k }, () => ({ items: [], total: 0 }));
                let sortedItems = [...currentItems].sort((a, b) => b.price - a.price);

                sortedItems.forEach(item => {
                    orders.sort((a, b) => a.total - b.total);
                    orders[0].items.push(item);
                    orders[0].total += item.price;
                });

                for (let iter = 0; iter < items.length * k * 2; iter++) {
                    let moved = false;
                    for (let i = 0; i < k; i++) {
                        for (let j = 0; j < k; j++) {
                            if (i === j) continue;
                            for (let itemIdx = 0; itemIdx < orders[i].items.length; itemIdx++) {
                                const item = orders[i].items[itemIdx];
                                const currentBenefitOfPair = getNetBenefit(orders[i].total) + getNetBenefit(orders[j].total);
                                const newBenefitIfMoved = getNetBenefit(orders[i].total - item.price) + getNetBenefit(orders[j].total + item.price);

                                if (newBenefitIfMoved > currentBenefitOfPair) {
                                    orders[j].items.push(item);
                                    orders[j].total += item.price;
                                    orders[i].items.splice(itemIdx, 1);
                                    orders[i].total -= item.price;
                                    moved = true;
                                    break;
                                }
                            }
                            if (moved) break;
                        }
                        if (moved) break;
                    }
                    if (!moved) break;
                }
                return orders.filter(o => o.items.length > 0);
            };

            const totalValue = items.reduce((sum, item) => sum + item.price, 0);
            const maxK = Math.min(items.length, Math.max(1, Math.floor(totalValue / (inputs.shipping.threshold || 100)) + 3, 7));

            let bestSolution = { orders: [{ items: [...items], total: totalValue }], benefit: -Infinity };
            bestSolution.benefit = getNetBenefitForOrderList(bestSolution.orders);

            for (let k = 1; k <= maxK; k++) {
                let ordersAttempt = solveForKOrders(k, items);
                if (ordersAttempt.reduce((sum, o) => sum + o.items.length, 0) !== items.length && items.length > 0) continue;

                let currentBenefit = getNetBenefitForOrderList(ordersAttempt);
                if (currentBenefit > bestSolution.benefit) {
                    bestSolution = { orders: ordersAttempt, benefit: currentBenefit };
                }
            }

            let skimmedOrdersIntermediate = [];
            let potentialIsolatedItems = [];

            for (const order of bestSolution.orders) {
                if (!order.items || order.items.length === 0) continue;

                let currentOrderItems = [...order.items];
                let currentOrderTotal = order.total;
                const initialBonusInfo = getBonusInfoForAmount(currentOrderTotal);
                const initialShippingFree = getShipping(currentOrderTotal) === 0;

                currentOrderItems.sort((a, b) => a.price - b.price);

                let finalKeptItemsForThisOrder = [...currentOrderItems];

                for (let i = 0; i < finalKeptItemsForThisOrder.length; i++) {
                    const itemToTestSkim = finalKeptItemsForThisOrder[i];
                    const tempTotalWithoutItem = finalKeptItemsForThisOrder.reduce((sum, it) => sum + it.price, 0) - itemToTestSkim.price;

                    if (tempTotalWithoutItem <= 0.001 && finalKeptItemsForThisOrder.length > 1) {
                    } else if (tempTotalWithoutItem <= 0.001 && finalKeptItemsForThisOrder.length === 1) {
                    } else {
                        const newBonusInfoAfterSkim = getBonusInfoForAmount(tempTotalWithoutItem);
                        const newShippingFreeAfterSkim = getShipping(tempTotalWithoutItem) === 0;

                        if (JSON.stringify(newBonusInfoAfterSkim.tiers) === JSON.stringify(initialBonusInfo.tiers) &&
                            newShippingFreeAfterSkim === initialShippingFree) {
                            potentialIsolatedItems.push(itemToTestSkim);
                            finalKeptItemsForThisOrder.splice(i, 1);
                            i--;
                        }
                    }
                }

                if (finalKeptItemsForThisOrder.length > 0) {
                    skimmedOrdersIntermediate.push({ items: finalKeptItemsForThisOrder, total: finalKeptItemsForThisOrder.reduce((s, i) => s + i.price, 0) });
                } else if (order.items.length > 0) {
                    potentialIsolatedItems.push(...order.items);
                }
            }

            let finalOrders = skimmedOrdersIntermediate.filter(o => o.items.length > 0 && o.total > 0.001);
            let isolatedOrderInfo = null;

            if (potentialIsolatedItems.length > 0) {
                const isolatedTotal = potentialIsolatedItems.reduce((sum, item) => sum + item.price, 0);
                const netBenefitOfIsolated = getNetBenefit(isolatedTotal);

                if (netBenefitOfIsolated >= 0 && isolatedTotal > 0.001) {
                    finalOrders.push({ items: [...potentialIsolatedItems], total: isolatedTotal });
                } else if (isolatedTotal > 0.001) {
                    isolatedOrderInfo = { totalAmount: isolatedTotal, itemCount: potentialIsolatedItems.length, items: [...potentialIsolatedItems] };

                    if (finalOrders.length > 0) {
                        finalOrders.sort((a, b) => {
                            const aOver = a.total >= inputs.shipping.threshold;
                            const bOver = b.total >= inputs.shipping.threshold;
                            if (aOver && !bOver) return -1;
                            if (!aOver && bOver) return 1;
                            return a.total - b.total;
                        });
                        let targetOrderIndex = 0;
                        for (let i = 0; i < finalOrders.length; i++) {
                            if (finalOrders[i].total >= inputs.shipping.threshold) {
                                targetOrderIndex = i;
                                break;
                            }
                        }

                        finalOrders[targetOrderIndex].items.push(...potentialIsolatedItems);
                        finalOrders[targetOrderIndex].total += isolatedTotal;
                    } else {
                        finalOrders.push({ items: [...potentialIsolatedItems], total: isolatedTotal });
                    }
                }
            }

            let totalBonusValue = 0, totalShippingFee = 0;
            let bonusCounts = { 1: 0, 2: 0, 3: 0 };
            finalOrders.forEach(order => {
                const bonus = getBonusInfoForAmount(order.total);
                order.bonus = bonus;
                totalBonusValue += bonus.value;
                bonus.tiers.forEach(tier => { if (bonusCounts[tier] !== undefined) bonusCounts[tier]++; });
                order.shipping = getShipping(order.total);
                totalShippingFee += order.shipping;
            });

            return { orders: finalOrders, totalBonusValue, totalShippingFee, bonusCounts, isolatedOrderInfo };
        }

        function displayOrderPlan(plan, inputs) {
            const outputDiv = document.getElementById('order-plan-output');
            if (!plan || !plan.orders || plan.orders.length === 0) {
                outputDiv.textContent = "æ— å•†å“ï¼Œæ— æ³•ç”Ÿæˆæ–¹æ¡ˆã€‚";
                document.getElementById('bonus1-count').textContent = 0;
                document.getElementById('bonus2-count').textContent = 0;
                document.getElementById('bonus3-count').textContent = 0;
                return;
            }

            let html = `æœ€ä½³æ–¹æ¡ˆå»ºè®®åˆ† ${plan.orders.length} å•ï¼ˆæ€»å‡€æ”¶ç›Šå‚è€ƒ: ${(plan.totalBonusValue - plan.totalShippingFee).toFixed(2)}å…ƒï¼‰\n\n`;
            plan.orders.sort((a, b) => b.total - a.total).forEach((order, index) => {
                html += `--- è®¢å• ${index + 1} ---\n`;
                html += `é‡‘é¢: ${order.total.toFixed(2)} å…ƒ\n`;
                const itemSummary = {};
                order.items.forEach(item => {
                    itemSummary[item.name] = (itemSummary[item.name] || 0) + 1;
                });
                const itemStrings = Object.entries(itemSummary).map(([name, count]) => `${name} x${count}`);
                html += `å•†å“: ${itemStrings.join(', ')}\n`;
                let bonusText = order.bonus.tiers.length > 0 ? `è·å¾— ${order.bonus.tiers.join('ã€')} æ¡£ç‰¹å…¸ (ä»·å€¼ ${order.bonus.value.toFixed(2)} å…ƒ)` : "æ— ç‰¹å…¸";
                html += `ç‰¹å…¸: ${bonusText}\n`;
                let shippingText = order.shipping > 0 ? `éœ€è¦é‚®è´¹ ${order.shipping.toFixed(2)} å…ƒ` : "åŒ…é‚®";
                html += `é‚®è´¹: ${shippingText}\n\n`;
            });

            html += `--- æ–¹æ¡ˆæ€»ç»“ ---\n`;
            html += `æ€»é‚®è´¹: ${plan.totalShippingFee.toFixed(2)} å…ƒ\n`;
            html += `ç‰¹å…¸è¯¦æƒ… (å‚è€ƒ): ä¸€æ¡£x${plan.bonusCounts[1]}, äºŒæ¡£x${plan.bonusCounts[2]}, ä¸‰æ¡£x${plan.bonusCounts[3]}\n`;
            html += `ç‰¹å…¸æ€»ä»·å€¼ (å‚è€ƒ): ${plan.totalBonusValue.toFixed(2)} å…ƒ\n`;
            if (plan.isolatedOrderInfo && plan.isolatedOrderInfo.totalAmount > 0) {
                html += `\næ³¨æ„: æ–¹æ¡ˆä¸­å­˜åœ¨ ${plan.isolatedOrderInfo.totalAmount.toFixed(2)} å…ƒçš„é›¶ç¢è°· (å« ${plan.isolatedOrderInfo.itemCount} ä»¶å•†å“)ï¼Œå› æ— æ³•ç‹¬ç«‹äº§ç”Ÿæ­£å‡€æ”¶ç›Šï¼Œå·²å°è¯•åˆå¹¶ã€‚`;
            }
            outputDiv.textContent = html;

            document.getElementById('bonus1-count').textContent = plan.bonusCounts[1];
            document.getElementById('bonus2-count').textContent = plan.bonusCounts[2];
            document.getElementById('bonus3-count').textContent = plan.bonusCounts[3];
        }

        function updateBonusGapInfo(preDiscountTotalFromUI, inputs, plan) {
            const infoDiv = document.getElementById('bonus-gap-info');
            if (!plan) {
                infoDiv.textContent = 'æ— æ³•ç”Ÿæˆæ–¹æ¡ˆæˆ–æ— å•†å“å¯è§„åˆ’ã€‚';
                return;
            }

            let messages = [];
            const getBonusInfoForAmount = (amount) => {
                let bonus = { value: 0, tiers: [] };
                if (inputs.bonus3.enabled && inputs.bonus3.threshold > 0 && amount >= inputs.bonus3.threshold) {
                    bonus.value += inputs.bonus3.value; bonus.tiers.push(3);
                }
                if (inputs.bonus2.threshold > 0 && amount >= inputs.bonus2.threshold) {
                    bonus.value += inputs.bonus2.value; bonus.tiers.push(2);
                }
                if (amount > 0.001 && inputs.bonus1.value > 0) {
                    bonus.value += inputs.bonus1.value; bonus.tiers.push(1);
                }
                bonus.tiers = [...new Set(bonus.tiers)].sort((a, b) => a - b);
                return bonus;
            };

            if (plan.isolatedOrderInfo && plan.isolatedOrderInfo.totalAmount > 0) {
                const { totalAmount, itemCount } = plan.isolatedOrderInfo;
                messages.push(`å½“å‰å‡‘å•æ–¹æ¡ˆå­˜åœ¨ ${totalAmount.toFixed(2)} å…ƒçš„é›¶ç¢è°· (å«${itemCount}ä»¶å•†å“)ï¼Œå·²å°è¯•åˆå¹¶åˆ°å…¶ä»–è®¢å•ã€‚`);

                const allAvailableTiersForIsolated = [];
                if (inputs.shipping.threshold > 0 && totalAmount < inputs.shipping.threshold) {
                    allAvailableTiersForIsolated.push({ level_desc: `åŒ…é‚® (${inputs.shipping.threshold.toFixed(2)}å…ƒ)`, threshold: inputs.shipping.threshold, level: 0.5 });
                }
                if (inputs.bonus1.value > 0) {
                    const thresholdForB1AndShipping = inputs.shipping.threshold > 0 ? Math.max(0.01, inputs.shipping.threshold) : 0.01;
                    if (totalAmount < thresholdForB1AndShipping) {
                        allAvailableTiersForIsolated.push({ level_desc: `ä¸€æ¡£ç‰¹å…¸ (+åŒ…é‚® if applicable)`, threshold: thresholdForB1AndShipping, level: 1 });
                    }
                }
                if (inputs.bonus2.threshold > 0 && totalAmount < inputs.bonus2.threshold) {
                    allAvailableTiersForIsolated.push({ level: 2, threshold: inputs.bonus2.threshold, level_desc: "äºŒæ¡£" });
                }
                if (inputs.bonus3.enabled && inputs.bonus3.threshold > 0 && totalAmount < inputs.bonus3.threshold) {
                    allAvailableTiersForIsolated.push({ level: 3, threshold: inputs.bonus3.threshold, level_desc: "ä¸‰æ¡£" });
                }
                allAvailableTiersForIsolated.sort((a, b) => a.threshold - b.threshold);

                const nextTierForIsolated = allAvailableTiersForIsolated.find(t => t.threshold > totalAmount);
                if (nextTierForIsolated) {
                    const gap = nextTierForIsolated.threshold - totalAmount;
                    messages.push(` -> è¿™éƒ¨åˆ†é›¶ç¢è°·è·ç¦»ç‹¬ç«‹æˆå•å¹¶è¾¾åˆ°"${nextTierForIsolated.level_desc}"è¿˜å·® ${gap.toFixed(2)}å…ƒã€‚`);
                } else if (getBonusInfoForAmount(totalAmount).value - ((inputs.shipping.threshold > 0 && totalAmount < inputs.shipping.threshold) ? inputs.shipping.fee : 0) < 0) {
                    messages.push(` -> è¿™éƒ¨åˆ†é›¶ç¢è°·å³ä½¿ç‹¬ç«‹ä¹Ÿæ— æ³•äº§ç”Ÿæ­£å‡€æ”¶ç›Šã€‚`);
                }
            }

            plan.orders.forEach((order, index) => {
                const currentOrderBonusInfo = getBonusInfoForAmount(order.total);
                const allAvailableTiersForOrder = [];
                if (inputs.shipping.threshold > 0 && order.shipping > 0 && order.total < inputs.shipping.threshold) {
                    allAvailableTiersForOrder.push({ level: 0.5, threshold: inputs.shipping.threshold, name: "åŒ…é‚®" });
                }
                if (inputs.bonus2.threshold > 0 && !currentOrderBonusInfo.tiers.includes(2) && order.total < inputs.bonus2.threshold) {
                    allAvailableTiersForOrder.push({ level: 2, threshold: inputs.bonus2.threshold, name: "äºŒæ¡£" });
                }
                if (inputs.bonus3.enabled && inputs.bonus3.threshold > 0 && !currentOrderBonusInfo.tiers.includes(3) && order.total < inputs.bonus3.threshold) {
                    allAvailableTiersForOrder.push({ level: 3, threshold: inputs.bonus3.threshold, name: "ä¸‰æ¡£" });
                }
                allAvailableTiersForOrder.sort((a, b) => a.threshold - b.threshold);

                const nextTierForOrder = allAvailableTiersForOrder[0];

                if (nextTierForOrder) {
                    const gap = nextTierForOrder.threshold - order.total;
                    if (gap > 0.001) {
                        messages.push(`è®¢å• ${index + 1} (${order.total.toFixed(2)}å…ƒ) è·ç¦»æ›´é«˜æ¡£(${nextTierForOrder.name}ç‰¹å…¸/åŒ…é‚®, ${nextTierForOrder.threshold.toFixed(2)}å…ƒ)è¿˜å·® ${gap.toFixed(2)}å…ƒã€‚`);
                    }
                }
            });

            if (messages.length === 0 && plan.orders.length > 0) {
                messages.push("æ‰€æœ‰è®¢å•å‡å·²æ»¡è¶³æ‰€æœ‰å¯ç”¨ç‰¹å…¸é—¨æ§›æˆ–æ— æ›´é«˜é—¨æ§›/åŒ…é‚®ã€‚");
            } else if (plan.orders.length === 0 && (!plan.isolatedOrderInfo || plan.isolatedOrderInfo.totalAmount === 0)) {
                messages.push("æ— å•†å“æˆ–è®¢å•ï¼Œæ— æ³•æä¾›å‡‘å•å»ºè®®ã€‚");
            }

            infoDiv.textContent = messages.join('\n');
        }

        function generateTables(savedTableRows) {
            const tabsContainer = document.getElementById('item-tabs');
            const tablesContainer = document.getElementById('item-tables-container');
            tabsContainer.innerHTML = '';
            tablesContainer.innerHTML = '';

            let currentOrderedTabs = [...orderedTypesForTabs];
            currentOrderedTabs = currentOrderedTabs.filter(typeKey => itemTypes[typeKey]);

            Object.keys(itemTypes).forEach(typeKey => {
                if (!currentOrderedTabs.includes(typeKey)) {
                    if (itemTypes[typeKey].isDynamicTabContent) {
                        currentOrderedTabs.push(typeKey);
                    } else {
                        const insertBeforeIdx = currentOrderedTabs.findIndex(k => itemTypes[k] && itemTypes[k].isDynamicTabContent);
                        if (insertBeforeIdx !== -1) currentOrderedTabs.splice(insertBeforeIdx, 0, typeKey);
                        else currentOrderedTabs.push(typeKey);
                    }
                }
            });
            orderedTypesForTabs = [...new Set(currentOrderedTabs)];

            let firstItemTabKey = null;

            orderedTypesForTabs.forEach((typeKey) => {
                const itemConfig = itemTypes[typeKey];
                if (!itemConfig) return;

                if (firstItemTabKey === null) firstItemTabKey = typeKey;

                const idPrefix = itemConfig.id_prefix;
                const defaults = itemConfig.defaults || { name: itemConfig.key, price: '', chars: '', sets: '' };

                let currentDisplayName = defaults.name || itemConfig.key;
                let currentPrice = defaults.price;
                let currentChars = defaults.chars;
                let currentSets = defaults.sets;

                const button = document.createElement('button');
                button.className = `item-tab-button`;
                button.textContent = `ã€${currentDisplayName}ã€‘`;
                button.dataset.tab = typeKey;
                button.onclick = () => showItemTab(typeKey);
                tabsContainer.appendChild(button);

                const tableDiv = document.createElement('div');
                tableDiv.id = `table-${typeKey}`;
                tableDiv.className = `item-tab-content`;

                let configHTML = '';
                if (!itemConfig.isDynamicTabContent) {
                    configHTML += `<div class="item-config-header">
                <div class="input-group"><label>å•†å“å</label><input type="text" id="item-name-${idPrefix}" value="${currentDisplayName}" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>
                <div class="input-group"><label>ä»·æ ¼</label><input type="number" id="item-price-${idPrefix}" value="${currentPrice}" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>`;
                    if (itemConfig.hasChars) {
                        configHTML += `<div class="input-group"><label>è§’è‰²æ•°</label><input type="number" id="item-chars-${idPrefix}" value="${currentChars}" min="0" oninput="handleCharacterCountChangeAndCalc('${typeKey}')"></div>`;
                    }
                    if (itemConfig.hasSets) {
                        configHTML += `<div class="input-group"><label>${itemConfig.setsLabel || 'é…æ•°'}</label><input type="number" id="item-sets-${idPrefix}" value="${currentSets}" min="0" oninput="updateItemConfigAndRecalculate('${typeKey}')"></div>`;
                    }
                    if (itemConfig.isDynamic) {
                        configHTML += `<button class="remove-btn-text" style="font-size:1em; padding:5px; background-color:var(--accent-color); color:white; border-radius:4px;" onclick="removeDynamicItemType('${typeKey}')">åˆ é™¤æ­¤å•†å“ç±»å‹</button>`;
                    }
                    configHTML += `</div>`;
                }

                let tableTitle = `${currentDisplayName} æ’è¡¨`;
                let tableHTMLContent = `<div class="table-scroll-wrapper"><table id="data-table-${typeKey}"><thead><tr>`;
                if (itemConfig.isSticker) tableHTMLContent += `<th class="col-name">è§’è‰²/ç§ç±»</th><th class="col-status">çŠ¶æ€</th><th class="col-value">å‡ä»·</th><th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-${typeKey}" class="warning-text"></span></th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-value">ä½™é‡</th><th class="col-operation">æ“ä½œ</th>`;
                else if (typeKey === 'bonus') tableHTMLContent += `<th class="col-name">æ¡£æ¬¡</th><th class="col-name">ç§ç±»</th><th class="col-value">ä»·å€¼</th><th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-${typeKey}" class="warning-text"></span></th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-value">ä½™é‡</th><th class="col-operation">æ“ä½œ</th>`;
                else if (typeKey === 'single') tableHTMLContent += `<th class="col-name">è§’è‰²</th><th class="col-name">ç§ç±»</th><th class="col-value">åŸä»·</th><th class="col-value">æŠ˜åä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-operation">æ“ä½œ</th>`;
                else tableHTMLContent += `<th class="col-name">è§’è‰²</th><th class="col-value">å‡ä»·</th><th class="col-value">è°ƒä»· <span id="è°ƒä»·æé†’-${typeKey}" class="warning-text"></span></th><th class="col-value">ç»ˆä»·</th><th class="col-distribution">æ’è¡¨</th><th class="col-value">ä½™é‡</th>`;

                tableHTMLContent += `</tr></thead><tbody></tbody></table></div>`;

                if (itemConfig.isDynamicTabContent) {
                    tableHTMLContent += `<button class="add-row-btn" onclick="addDynamicRow('${typeKey}')">æ·»åŠ ä¸€è¡Œ</button>`;
                }
                tableHTMLContent += `<button onclick="calculatePageBill('${typeKey}')">è®¡ç®—æœ¬é¡µè‚¾è¡¨</button><div id="page-bill-${typeKey}" class="info-text" style="white-space: pre-wrap;"></div>`;

                tableDiv.innerHTML = configHTML + `<h3>${tableTitle}</h3>` + tableHTMLContent;
                tablesContainer.appendChild(tableDiv);

                const tableBody = document.querySelector(`#data-table-${typeKey} tbody`);
                const currentSavedTableRowsForType = savedTableRows ? savedTableRows[itemConfig.key] : null;

                if (currentSavedTableRowsForType && currentSavedTableRowsForType.length > 0) {
                    currentSavedTableRowsForType.forEach((rowData, i) => {
                        const newRow = tableBody.insertRow();
                        populateTableRow(newRow, typeKey, i, rowData);
                    });
                }

                if (!itemConfig.isDynamicTabContent && itemConfig.hasChars) {
                    const targetCharCount = parseInt(itemConfig.defaults.chars) || 0;
                    const currentRowCount = tableBody.rows.length;
                    if (targetCharCount > currentRowCount) {
                        for (let i = currentRowCount; i < targetCharCount; i++) {
                            const newRow = tableBody.insertRow();
                            populateTableRow(newRow, typeKey, i, {});
                        }
                    }
                } else if (typeKey === 'single' && (!currentSavedTableRowsForType || currentSavedTableRowsForType.length === 0)) {
                    addDefaultSingleItems();
                }
            });

            const addNewButton = document.createElement('button');
            addNewButton.textContent = '+ æ–°å¢å•†å“ç±»å‹';
            addNewButton.className = 'item-tab-button add-new-item-type-btn';
            addNewButton.onclick = addNewCustomItemType;
            tabsContainer.appendChild(addNewButton);

            if (firstItemTabKey) {
                showItemTab(firstItemTabKey);
            } else if (orderedTypesForTabs.length > 0) {
                const firstValidTab = orderedTypesForTabs.find(key => itemTypes[key]);
                if (firstValidTab) showItemTab(firstValidTab);
            }
        }

        function populateTableRow(row, typeKey, index, data) {
            const itemConfig = itemTypes[typeKey];
            row.dataset.type = typeKey;
            row.dataset.index = index;
            row.dataset.splitCount = data.splitCount || 1;
            const onInputDist = 'oninput="updateAllRemainingQuantities()"';
            const onKeyDown = `handleDistroInput(event, '${typeKey}')`;

            const distCellContent = (distDataArray = []) => {
                let content = `<div class="distribution-container">`;
                let currentDistData = Array.isArray(distDataArray) ? distDataArray : [];
                if (currentDistData.length === 0) {
                    currentDistData = [{ name: '', quantity: '' }];
                }
                currentDistData.forEach(d => {
                    const currentName = (typeof d === 'object' && d !== null && d.name !== undefined) ? d.name : '';
                    const currentQuantity = (typeof d === 'object' && d !== null && d.quantity !== undefined) ? d.quantity : '';
                    content += `<div class="dist-entry"><input type="text" class="dist-name" placeholder="åå­—" value="${currentName}" onkeydown="${onKeyDown}"><input type="number" class="dist-quantity" placeholder="æ•°é‡" min="0" value="${currentQuantity}" onkeydown="${onKeyDown}" ${onInputDist}><button type="button" class="remove-btn-text" onclick="removeDistributionEntry(this, '${typeKey}')">Ã—</button></div>`;
                });
                content += `</div><button type="button" class="add-btn-text" onclick="addDistributionEntry(this, '${typeKey}')">+</button>`;
                return content;
            };

            let rowHTML = '';
            const distributionCellClass = 'class="distribution-cell col-distribution"';

            if (itemConfig.isSticker) {
                const isSplit = data.status?.includes('å•å¼ ');
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}"></td><td class="col-status sticker-status">${data.status || 'ä¸€å¯¹'}</td><td class="col-value avg-price">0.00</td><td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateRowPrice('${typeKey}', this)"></td><td class="col-value final-price">0.00</td><td ${distributionCellClass}>${distCellContent(data.distribution)}</td><td class="col-value remaining-quantity">N/A</td><td class="col-operation"><button class="split-btn" onclick="splitSticker(this.parentElement.parentElement, ${index}, '${typeKey}')">${isSplit ? '-' : 'æ‹†åˆ†'}</button></td>`;
            } else if (typeKey === 'bonus') {
                const isCurrentlySplittable = (parseInt(data.splitCount || 1) === 1);
                rowHTML = `<td class="col-name"><input type="text" data-type="kind" value="${data.tier || ''}" readonly></td><td class="col-name"><input type="text" class="custom-kind" placeholder="è‡ªå®šä¹‰ç§ç±»å..." value="${data.customKind || ''}"></td><td class="col-value"><input type="number" data-type="price" value="${data.priceForDisplay || '0.00'}" readonly></td><td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateRowPrice('${typeKey}', this)"></td><td class="col-value final-price">0.00</td><td ${distributionCellClass}>${distCellContent(data.distribution)}</td><td class="col-value remaining-quantity">N/A</td><td class="col-operation">${isCurrentlySplittable ? `<button class="split-btn" onclick="splitBonusRow(this, '${typeKey}')">æ‹†åˆ†</button>` : ''}<button type="button" class="remove-btn-text" onclick="this.closest('tr').remove();">Ã—</button></td>`;
            } else if (typeKey === 'single') {
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}"></td><td class="col-name"><input type="text" data-type="kind" value="${data.kind || ''}"></td><td class="col-value"><input type="number" data-type="price" value="${data.price || 0}"></td><td class="col-value final-price">0.00</td><td ${distributionCellClass}>${distCellContent(data.distribution)}</td><td class="col-operation"><button type="button" class="remove-btn-text" onclick="this.parentElement.parentElement.remove();">Ã—</button></td>`;
            } else {
                rowHTML = `<td class="col-name"><input type="text" placeholder="è§’è‰²å..." value="${data.charName || ''}"></td><td class="col-value avg-price">0.00</td><td class="col-value"><input type="number" class="adj-price" value="${data.adjPrice || 0}" oninput="updateRowPrice('${typeKey}', this)"></td><td class="col-value final-price">0.00</td><td ${distributionCellClass}>${distCellContent(data.distribution)}</td><td class="col-value remaining-quantity">N/A</td>`;
            }
            row.innerHTML = rowHTML;
        }

        function addDynamicRow(typeKey) {
            const itemConfig = itemTypes[typeKey];
            const tableBody = document.querySelector(`#data-table-${typeKey} tbody`);
            if (!tableBody) return;
            const newIndex = tableBody.rows.length;
            const newRow = tableBody.insertRow();
            if (typeKey === 'bonus') populateTableRow(newRow, typeKey, newIndex, { tier: 'è‡ªå®šä¹‰ç‰¹å…¸', customKind: '', priceForDisplay: '0.00', splitCount: 1 });
            else populateTableRow(newRow, typeKey, newIndex, {});
        }

        function addDefaultSingleItems() {
            const defaultItems = [
                { charName: '', kind: 'çš®è‚¤å§å”§', price: 20 },
                { charName: '', kind: 'çš®è‚¤å§å”§', price: 20 },
                { charName: '', kind: 'çš®è‚¤å§å”§', price: 20 },
                { charName: '', kind: 'ç²¾ä¸€ç«‹ç‰Œ', price: 50 },
                { charName: '', kind: 'ç²¾ä¸€ç«‹ç‰Œ', price: 50 },
                { charName: '', kind: 'ç²¾ä¸€ç«‹ç‰Œ', price: 50 },
                { charName: '', kind: 'å§å”§ç»„', price: 30 },
                { charName: '', kind: 'å§å”§ç»„', price: 30 },
                { charName: '', kind: 'å§å”§ç»„', price: 30 },
                { charName: '', kind: 'çš®è‚¤æŒ‚ä»¶', price: 35 },
                { charName: '', kind: 'çš®è‚¤æŒ‚ä»¶', price: 35 }
            ];
            const tableBody = document.querySelector('#data-table-single tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            defaultItems.forEach((item, index) => {
                const newRow = tableBody.insertRow();
                populateTableRow(newRow, 'single', index, item);
            });
        }


        function handleDistroInput(event, typeKey) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addDistributionEntry(event.target, typeKey);
            }
        }

        function addDistributionEntry(element, typeKey) {
            const container = element.closest('.distribution-cell').querySelector('.distribution-container');
            const onInput = 'oninput="updateAllRemainingQuantities()"';
            const onKeyDown = `handleDistroInput(event, '${typeKey}')`;
            const newEntry = document.createElement('div');
            newEntry.className = 'dist-entry';
            newEntry.innerHTML = `<input type="text" class="dist-name" placeholder="åå­—" onkeydown="${onKeyDown}"><input type="number" class="dist-quantity" placeholder="æ•°é‡" min="0" value="" onkeydown="${onKeyDown}" ${onInput}><button type="button" class="remove-btn-text" onclick="removeDistributionEntry(this, '${typeKey}')">Ã—</button>`;
            container.appendChild(newEntry);
            newEntry.querySelector('.dist-name').focus();
            updateAllRemainingQuantities();
        }

        function removeDistributionEntry(button, typeKey) {
            const entry = button.parentElement;
            const container = entry.parentElement;
            entry.remove();
            if (container.children.length === 0) addDistributionEntry(container.nextElementSibling, typeKey);
            updateAllRemainingQuantities();
        }

        function splitSticker(row, index, typeKey) {
            const isPair = row.querySelector('.sticker-status').textContent === 'ä¸€å¯¹';
            if (isPair) {
                row.querySelector('.sticker-status').textContent = 'å•å¼  (1/2)';
                row.querySelector('.split-btn').textContent = '-';

                const newRowEl = document.createElement('tr');
                populateTableRow(newRowEl, typeKey, `${index}-2`, { status: 'å•å¼  (2/2)' });

                row.after(newRowEl);

                const newRowInDOM = row.nextElementSibling;
                if (newRowInDOM) {
                    newRowInDOM.querySelector('.split-btn').textContent = 'åˆå¹¶';
                    newRowInDOM.querySelector('.split-btn').onclick = () => mergeSticker(row, newRowInDOM, typeKey);
                }
            }
            updateAllTablePrices();
        }

        function mergeSticker(row1, row2, typeKey) {
            row1.querySelector('.sticker-status').textContent = 'ä¸€å¯¹';
            row1.querySelector('.split-btn').textContent = 'æ‹†åˆ†';
            const originalIndex = parseInt(row1.dataset.index.split('-')[0]);
            row1.querySelector('.split-btn').onclick = () => splitSticker(row1, originalIndex, typeKey);
            row2.remove();
            updateAllTablePrices();
        }

        function splitBonusRow(button, typeKey) {
            const row = button.closest('tr');
            const tierInput = row.querySelector('input[data-type="kind"]');
            const baseTierText = tierInput.value.split(' (')[0];
            const customKind = row.querySelector('.custom-kind')?.value || '';
            const parts = parseInt(prompt(`å°†â€œ${baseTierText} - ${customKind || 'æœªå‘½å'}â€æ‹†åˆ†æˆå‡ ä»½ï¼Ÿ`, "2"), 10);
            if (!parts || parts < 2) return;
            const inputs = getInputs();
            let fullOriginalValue = 0;
            if (baseTierText.includes('ä¸€æ¡£')) fullOriginalValue = inputs.bonus1.value;
            else if (baseTierText.includes('äºŒæ¡£')) fullOriginalValue = inputs.bonus2.value;
            else if (baseTierText.includes('ä¸‰æ¡£') && inputs.bonus3.enabled) fullOriginalValue = inputs.bonus3.value;
            const splitValue = fullOriginalValue / parts;
            const baseIndex = row.dataset.index;
            const originalRowIndex = row.rowIndex;
            for (let i = 0; i < parts; i++) {
                const newRow = row.parentElement.insertRow(originalRowIndex + i);
                populateTableRow(newRow, typeKey, `${baseIndex}-${i}`, { tier: `${baseTierText} (${i + 1}/${parts})`, customKind: customKind, priceForDisplay: splitValue.toFixed(2), splitCount: parts });
            }
            row.remove();
            updateAllTablePrices();
        }

        function updateAllTablePrices() {
            let finalDiscountRate = parseFloat(document.getElementById('final-discount-rate').textContent);
            if (isNaN(finalDiscountRate)) finalDiscountRate = 1.0;
            const ceil2 = val => Math.ceil(val * 100) / 100;
            const currentCalcInputs = getInputs();
            const bonusValuesFromCalc = { 'ä¸€æ¡£ç‰¹å…¸': currentCalcInputs.bonus1.value, 'äºŒæ¡£ç‰¹å…¸': currentCalcInputs.bonus2.value, 'ä¸‰æ¡£ç‰¹å…¸': currentCalcInputs.bonus3.enabled ? currentCalcInputs.bonus3.value : 0 };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                let avgPrice = 0;
                if (itemConfig.avgPriceId) avgPrice = parseFloat(document.getElementById(itemConfig.avgPriceId)?.textContent) || 0;
                let totalAdj = 0;

                table.querySelectorAll('tbody tr').forEach(row => {
                    const adjPriceInput = row.querySelector('.adj-price');
                    const adjPrice = adjPriceInput ? (parseFloat(adjPriceInput.value) || 0) : 0;
                    if (typeKey === 'single') {
                        const originalPrice = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                        row.querySelector('.final-price').textContent = ceil2(originalPrice * finalDiscountRate).toFixed(2);
                    } else if (typeKey === 'bonus') {
                        const tierInput = row.querySelector('input[data-type="kind"]');
                        const tierText = tierInput ? tierInput.value : '';
                        const baseTier = tierText.split(' (')[0];
                        let originalBonusValueForThisTier = bonusValuesFromCalc[baseTier] || 0;
                        const splitCount = parseInt(row.dataset.splitCount) || 1;
                        const currentCalculatedValue = originalBonusValueForThisTier / splitCount;
                        const valueDisplayInput = row.querySelector('input[data-type="price"]');
                        if (valueDisplayInput) valueDisplayInput.value = currentCalculatedValue.toFixed(2);
                        row.querySelector('.final-price').textContent = ceil2(currentCalculatedValue + adjPrice).toFixed(2);
                        totalAdj += adjPrice;
                    } else {
                        let currentAvgPrice = avgPrice;
                        if (itemConfig.isSticker) {
                            const isSplit = row.querySelector('.sticker-status').textContent.includes('å•å¼ ');
                            currentAvgPrice = isSplit ? (parseFloat(document.getElementById('final-sticker-single-price').textContent) || 0) : (parseFloat(document.getElementById('final-sticker-pair-price').textContent) || 0);
                        }
                        const avgPriceCell = row.querySelector('.avg-price');
                        if (avgPriceCell) avgPriceCell.textContent = currentAvgPrice.toFixed(2);

                        totalAdj += adjPrice;
                        row.querySelector('.final-price').textContent = ceil2(currentAvgPrice + adjPrice).toFixed(2);
                    }
                });
                const warningSpan = document.getElementById(`è°ƒä»·æé†’-${typeKey}`);
                if (warningSpan) warningSpan.textContent = Math.abs(totalAdj) > 0.01 ? `è°ƒä»·æ€»å’Œä¸ä¸º0 (${totalAdj.toFixed(2)})` : '';
            });
            populateBonusTable();
            updateAllRemainingQuantities();
        }

        function updateRowPrice(typeKey, element) {
            const row = element.closest('tr');
            if (!row) return;
            let basePrice = 0;
            let finalPriceCell = row.querySelector('.final-price');
            const adjPrice = parseFloat(row.querySelector('.adj-price')?.value || 0);
            const ceil2 = val => Math.ceil(val * 100) / 100;

            if (typeKey === 'bonus') {
                basePrice = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                finalPriceCell.textContent = ceil2(basePrice + adjPrice).toFixed(2);
            } else if (typeKey === 'single') {
                const originalPrice = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                let finalDiscountRate = parseFloat(document.getElementById('final-discount-rate').textContent);
                if (isNaN(finalDiscountRate)) finalDiscountRate = 1.0;
                basePrice = originalPrice * finalDiscountRate;
                finalPriceCell.textContent = ceil2(basePrice).toFixed(2);
            } else {
                const avgPriceCell = row.querySelector('.avg-price');
                if (avgPriceCell) basePrice = parseFloat(avgPriceCell.textContent) || 0;
                finalPriceCell.textContent = ceil2(basePrice + adjPrice).toFixed(2);
            }
            let totalAdj = 0;
            document.querySelectorAll(`#data-table-${typeKey} .adj-price`).forEach(input => totalAdj += parseFloat(input.value) || 0);
            const warningSpan = document.getElementById(`è°ƒä»·æé†’-${typeKey}`);
            if (warningSpan) warningSpan.textContent = Math.abs(totalAdj) > 0.01 ? `è°ƒä»·æ€»å’Œä¸ä¸º0 (${totalAdj.toFixed(2)})` : '';
        }

        function populateBonusTable() {
            const bonusTableBody = document.querySelector('#data-table-bonus tbody');
            if (!bonusTableBody) return;
            const existingBaseTiers = new Set();
            bonusTableBody.querySelectorAll('input[data-type="kind"]').forEach(i => existingBaseTiers.add(i.value.split(' (')[0]));
            const inputs = getInputs();
            const addBonusRowIfNeeded = (tierName, value) => {
                if (value > 0 && !existingBaseTiers.has(tierName)) {
                    const newIndex = bonusTableBody.rows.length;
                    const newRow = bonusTableBody.insertRow();
                    populateTableRow(newRow, 'bonus', newIndex, { tier: tierName, customKind: '', priceForDisplay: value.toFixed(2), splitCount: 1 });
                }
            };
            addBonusRowIfNeeded('ä¸€æ¡£ç‰¹å…¸', inputs.bonus1.value);
            addBonusRowIfNeeded('äºŒæ¡£ç‰¹å…¸', inputs.bonus2.value);
            if (inputs.bonus3.enabled) addBonusRowIfNeeded('ä¸‰æ¡£ç‰¹å…¸', inputs.bonus3.value);
        }

        function getDistributionFromInputs(row) {
            const entries = {};
            row.querySelectorAll('.dist-entry').forEach(entry => {
                const name = entry.querySelector('.dist-name').value.trim();
                const quantity = parseInt(entry.querySelector('.dist-quantity').value, 10) || 0;
                // The key change is here: now it only checks for quantity > 0
                if (quantity > 0) {
                    // If the name is empty, use a placeholder so it's still counted and can be identified.
                    const key = name || 'ï¼ˆæœªåˆ†é…ï¼‰';
                    entries[key] = (entries[key] || 0) + quantity;
                }
            });
            return entries;
        }

        function calculatePageBill(typeKey) {
            const table = document.getElementById(`data-table-${typeKey}`);
            const outputDiv = document.getElementById(`page-bill-${typeKey}`);
            const bill = {};
            if (!table || !outputDiv) return;
            table.querySelectorAll('tbody tr').forEach(row => {
                let priceForBilling = parseFloat(row.querySelector('.final-price').textContent);
                const distribution = getDistributionFromInputs(row);
                for (const name in distribution) bill[name] = (bill[name] || 0) + (priceForBilling * distribution[name]);
            });
            let billText = 'æœ¬é¡µè‚¾è¡¨:\n';
            if (Object.keys(bill).length === 0) billText += 'æš‚æ— æ•°æ®';
            else Object.entries(bill).sort().forEach(([name, amount]) => billText += `${name}: ${amount.toFixed(2)} å…ƒ\n`);
            outputDiv.textContent = billText;
        }

        function calculateSummary() {
            const totalBill = {};
            const totalItems = {};
            const inputs = getInputs();

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                table.querySelectorAll('tbody tr').forEach(row => {
                    let priceForBilling = parseFloat(row.querySelector('.final-price').textContent);
                    const distribution = getDistributionFromInputs(row);
                    let itemName;
                    const currentItemNameFromConfig = inputs[typeKey] ? inputs[typeKey].name : itemConfig.key;

                    if (typeKey === 'single') {
                        const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                        const charName = charNameInput ? charNameInput.value.trim() : '';
                        const kindInput = row.querySelector('input[data-type="kind"]');
                        const kind = kindInput ? kindInput.value.trim() : '';
                        itemName = charName ? `${charName}-${kind}` : kind;
                    } else if (typeKey === 'bonus') {
                        const tierName = row.querySelector('input[data-type="kind"]').value;
                        const customName = row.querySelector('.custom-kind').value;
                        itemName = customName ? `${tierName} - ${customName}` : tierName;
                    } else if (itemConfig.isSticker) {
                        const charName = row.querySelector('input[type="text"]').value || `è§’è‰²${row.dataset.index}`;
                        const status = row.querySelector('.sticker-status').textContent;
                        itemName = `${currentItemNameFromConfig}-${charName} (${status})`;
                    } else {
                        const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                        const charName = charNameInput ? (charNameInput.value || `è§’è‰²${row.dataset.index}`) : `é¡¹ç›®${row.dataset.index}`;
                        itemName = `${currentItemNameFromConfig}-${charName}`;
                    }

                    for (const person in distribution) {
                        totalBill[person] = (totalBill[person] || 0) + (priceForBilling * distribution[person]);
                        if (!totalItems[person]) totalItems[person] = [];
                        totalItems[person].push(`${itemName} x ${distribution[person]}`);
                    }
                });
            });
            const billOutput = document.getElementById('total-bill-output');
            let billText = '';
            let actualTotal = 0;
            if (Object.keys(totalBill).length === 0) billText = 'è¯·å…ˆåœ¨å„åˆ†è¡¨ä¸­å¡«å†™æ’è¡¨ä¿¡æ¯ã€‚';
            else Object.entries(totalBill).sort().forEach(([person, amount]) => { billText += `${person}: ${amount.toFixed(2)} å…ƒ\n`; actualTotal += amount; });
            billOutput.textContent = billText;
            const itemsOutput = document.getElementById('total-items-output');
            let itemsText = '';
            if (Object.keys(totalItems).length === 0) itemsText = 'è¯·å…ˆåœ¨å„åˆ†è¡¨ä¸­å¡«å†™æ’è¡¨ä¿¡æ¯ã€‚';
            else Object.keys(totalItems).sort().forEach(person => { itemsText += `--- ${person} ---\n${totalItems[person].join('\n')}\n\n`; });
            itemsOutput.textContent = itemsText;
            const totalAfterDiscount = parseFloat(document.getElementById('total-after-discount').textContent) || 0;
            const totalBonusValue = parseFloat(document.getElementById('bonus-total-value').textContent) || 0;
            const expectedTotal = totalAfterDiscount + totalBonusValue;
            document.getElementById('expected-total').textContent = expectedTotal.toFixed(2);
            document.getElementById('actual-total').textContent = actualTotal.toFixed(2);
            const diff = expectedTotal - actualTotal;
            const diffEl = document.getElementById('check-diff');
            if (Math.abs(diff) < 0.02) { diffEl.textContent = 'âœ… æ ¸å¯¹æˆåŠŸï¼è´¦å¹³å•¦ï¼'; diffEl.style.color = 'var(--success-color)'; }
            else { diffEl.textContent = `âš ï¸ æ ¸å¯¹å¤±è´¥ï¼å·®é¢: ${diff.toFixed(2)} å…ƒã€‚è¯·æ£€æŸ¥è°ƒä»·ã€æ’è¡¨æ•°é‡æˆ–æœ€ç»ˆæŠ˜æ‰£è®¡ç®—ã€‚`; diffEl.style.color = 'var(--accent-color)'; }
            updateRemainingTable(); // è‡ªåŠ¨æ›´æ–°ä½™é‡è¡¨
        }

        function updateAllRemainingQuantities() {
            const inputs = getInputs();
            const baseQuantities = {
                bonus1: (inputs.bonus1.manual_count !== '' && inputs.bonus1.manual_count !== null) ? parseFloat(inputs.bonus1.manual_count) : (lastOrderPlan?.bonusCounts[1] || 0),
                bonus2: (inputs.bonus2.manual_count !== '' && inputs.bonus2.manual_count !== null) ? parseFloat(inputs.bonus2.manual_count) : (lastOrderPlan?.bonusCounts[2] || 0),
                bonus3: (inputs.bonus3.enabled && inputs.bonus3.manual_count !== '' && inputs.bonus3.manual_count !== null) ? parseFloat(inputs.bonus3.manual_count) : (inputs.bonus3.enabled ? (lastOrderPlan?.bonusCounts[3] || 0) : 0),
            };

            Object.keys(itemTypes).forEach(typeKey => {
                const itemDef = itemTypes[typeKey];
                if (!itemDef.isDynamicTabContent && inputs[typeKey] && typeof inputs[typeKey].sets !== 'undefined') {
                    baseQuantities[typeKey] = inputs[typeKey].sets;
                }
            });

            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];

                if (itemConfig.isDynamicTabContent && typeKey !== 'bonus') return;

                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                table.querySelectorAll('tbody tr').forEach(row => {
                    let baseQuantityForRow = 0;
                    if (typeKey === 'bonus') {
                        const tierText = row.querySelector('input[data-type="kind"]')?.value || '';
                        if (tierText.includes('ä¸€æ¡£')) baseQuantityForRow = baseQuantities.bonus1;
                        else if (tierText.includes('äºŒæ¡£')) baseQuantityForRow = baseQuantities.bonus2;
                        else if (tierText.includes('ä¸‰æ¡£')) baseQuantityForRow = baseQuantities.bonus3;
                    } else if (baseQuantities[typeKey] !== undefined) {
                        baseQuantityForRow = baseQuantities[typeKey] || 0;
                    }

                    const distribution = getDistributionFromInputs(row);
                    const totalDistributed = Object.values(distribution).reduce((sum, q) => sum + q, 0);
                    const remaining = baseQuantityForRow - totalDistributed;
                    const remainingCell = row.querySelector('.remaining-quantity');
                    if (remainingCell) remainingCell.textContent = remaining;
                });
            });
        }

        function showExportOptions() { document.getElementById('export-options-modal').style.display = 'block'; }
        function hideExportOptions() { document.getElementById('export-options-modal').style.display = 'none'; }
        function showDataSyncModal() { document.getElementById('data-sync-modal').style.display = 'block'; }
        function hideDataSyncModal() { document.getElementById('data-sync-modal').style.display = 'none'; }
        function showLoadModal() {
            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            const listContainer = document.getElementById('load-modal-list');
            listContainer.innerHTML = '';

            let slotNames = Object.keys(allSaves);

            // Ensure default slot is always an option, even if it has no data saved yet.
            if (!slotNames.includes(DEFAULT_SLOT_NAME)) {
                slotNames.push(DEFAULT_SLOT_NAME);
            }

            if (slotNames.length === 0) { // Should not happen due to the logic above, but for safety.
                listContainer.innerHTML = '<p style="text-align: center; color: var(--light-text-color);">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ¡£æ¡ˆã€‚</p>';
            } else {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.innerHTML = `<thead><tr><th style="text-align:left; padding: 4px;">æ¡£æ¡ˆå</th><th style="text-align:right; padding: 4px;">æ“ä½œ</th></tr></thead>`;
                const tbody = document.createElement('tbody');

                slotNames.sort((a, b) => {
                    if (a === DEFAULT_SLOT_NAME) return -1;
                    if (b === DEFAULT_SLOT_NAME) return 1;
                    return a.localeCompare(b);
                }).forEach(slotName => {
                    const tr = document.createElement('tr');
                    let displayName = slotName;
                    if (slotName === currentSlotName) {
                        displayName = `<strong>${slotName} (å½“å‰)</strong>`;
                        tr.style.backgroundColor = 'rgba(168, 208, 230, 0.2)';
                    }

                    tr.innerHTML = `
                <td style="padding: 8px 4px; vertical-align: middle;">${displayName}</td>
                <td style="text-align: right; padding: 8px 4px; white-space: nowrap;">
                    <button onclick="loadSlot('${slotName}')" style="margin-right: 5px; padding: 5px 10px; font-size: 0.9em;">è¯»å–</button>
                    ${slotName !== DEFAULT_SLOT_NAME ? `<button onclick="deleteSlot('${slotName}')" class="remove-btn-text" style="color:var(--accent-color); font-size:1.2em; vertical-align:middle; padding: 5px;">Ã—</button>` : ''}
                </td>
            `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                listContainer.appendChild(table);
            }

            document.getElementById('load-modal').style.display = 'block';
        }
        function hideLoadModal() { document.getElementById('load-modal').style.display = 'none'; }

        function loadSlot(slotName) {
            if (slotName === currentSlotName) {
                hideLoadModal();
                return;
            }

            // Explicitly save the current data before switching.
            saveData(true, false); // The 'true' marks it as an auto-save, updating the timestamp. 'false' hides user feedback.

            if (confirm(`å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘å·²è‡ªåŠ¨ä¿å­˜ã€‚ç¡®å®šè¦åˆ‡æ¢å¹¶è¯»å–æ¡£æ¡ˆã€${slotName}ã€‘å—ï¼Ÿ`)) {
                localStorage.setItem(ACTIVE_SLOT_KEY, slotName);
                location.reload();
            }
        }

        function deleteSlot(slotName) {
            if (slotName === DEFAULT_SLOT_NAME) {
                alert("ä¸èƒ½åˆ é™¤é»˜è®¤æ¡£æ¡ˆã€‚");
                return;
            }
            if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ¡£æ¡ˆ "${slotName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
                delete allSaves[slotName];
                localStorage.setItem(SAVE_MANIFEST_KEY, JSON.stringify(allSaves));

                if (currentSlotName === slotName) {
                    localStorage.setItem(ACTIVE_SLOT_KEY, DEFAULT_SLOT_NAME);
                    location.reload();
                } else {
                    showLoadModal();
                }
            }
        }

        function downloadExcelWorkbook(workbook, fileName) {
            if (typeof XLSX === 'undefined') { alert("é”™è¯¯ï¼šExcelå¯¼å‡ºåº“ (SheetJS) æœªåŠ è½½ã€‚"); return; }
            try { XLSX.writeFile(workbook, fileName); }
            catch (error) { console.error("å¯¼å‡ºExcelæ—¶å‘ç”Ÿé”™è¯¯:", error); alert("å¯¼å‡ºExcelå¤±è´¥ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚"); }
        }

        function getCalculatorDataForExport() {
            const data = [['é¡¹ç›®', 'å€¼/çŠ¶æ€']];
            const sections = document.querySelectorAll('#calculator-section .calc-section');
            sections.forEach(section => {
                const header = section.querySelector('h3');
                if (header) {
                    let headerText = header.textContent.trim();
                    const tooltipTrigger = header.querySelector('.tooltip-trigger');
                    if (tooltipTrigger) {
                        headerText = headerText.replace(tooltipTrigger.textContent, '').trim();
                    }
                    data.push([`ã€${headerText}ã€‘`, '']);
                }

                if (header && header.textContent.includes("æœ¬æ¬¡å¼€è°·")) {
                    Object.keys(itemTypes).forEach(typeKey => {
                        const itemConfig = itemTypes[typeKey];
                        if (itemConfig.isDynamicTabContent) return;

                        const idPrefix = itemConfig.id_prefix;
                        const nameLabelElement = document.getElementById(`${idPrefix}-price-label`);
                        const nameLabel = nameLabelElement ? nameLabelElement.textContent.split(' - ')[0] : itemConfig.key;
                        const priceVal = document.getElementById(`${idPrefix}-price-display`)?.textContent;
                        const setsVal = document.getElementById(`${idPrefix}-sets-display`)?.textContent;
                        if (priceVal !== undefined) data.push([`${nameLabel} - ä»·æ ¼`, priceVal]);
                        if (setsVal !== undefined) data.push([`${nameLabel} - ${itemConfig.setsLabel || (itemConfig.hasSets ? 'é…æ•°' : '')}`, setsVal]);
                    });
                }

                section.querySelectorAll('.input-group').forEach(group => {
                    const labelEl = group.querySelector('label');
                    const inputEls = group.querySelectorAll('input[type="number"], input[type="text"], input[type="checkbox"]');

                    let isHandledDisplayField = false;
                    if (labelEl && labelEl.id) {
                        Object.values(itemTypes).forEach(cfg => {
                            if (!cfg.isDynamicTabContent && (labelEl.id === `${cfg.id_prefix}-price-label` || labelEl.id === `${cfg.id_prefix}-sets-label`)) {
                                isHandledDisplayField = true;
                            }
                        });
                    }
                    if (isHandledDisplayField) return;

                    if (labelEl && inputEls.length === 1) {
                        const inputEl = inputEls[0];
                        let labelText = labelEl.textContent.trim();
                        if (labelEl.contains(inputEl)) {
                            const tempLabel = labelEl.cloneNode(true);
                            tempLabel.querySelectorAll('input').forEach(inp => inp.remove());
                            labelText = tempLabel.textContent.trim();
                        }
                        data.push([labelText, inputEl.type === 'checkbox' ? (inputEl.checked ? 'æ˜¯' : 'å¦') : inputEl.value]);
                    } else if (labelEl && group.textContent.includes('æ¯æ»¡') && group.textContent.includes('å‡')) {
                        const inputsInGroup = group.querySelectorAll('input[type="number"]');
                        if (inputsInGroup.length === 2) data.push([labelEl.textContent.trim(), `æ¯æ»¡ ${inputsInGroup[0].value} å‡ ${inputsInGroup[1].value}`]);
                    }
                });
                section.querySelectorAll('#extra-discounts .input-group, #extra-coupons .input-group').forEach(group => {
                    const labelEl = group.querySelector('label');
                    const inputEl = group.querySelector('.extra-discount-input, .extra-coupon-input');
                    if (labelEl && inputEl) data.push([labelEl.textContent.trim(), inputEl.value]);
                });
                section.querySelectorAll('p').forEach(p => {
                    const textContent = p.textContent.trim();
                    const valueEl = p.querySelector('.result-field, .final-result');
                    if (valueEl) {
                        let labelText = '';
                        const nameSpan = p.querySelector('span[id$="-name-display"]');
                        if (nameSpan) {
                            labelText = nameSpan.textContent.trim() + textContent.substring(textContent.indexOf(nameSpan.textContent) + nameSpan.textContent.length, textContent.indexOf(valueEl.textContent)).trim().replace(/:$/, '');
                        } else {
                            labelText = textContent.substring(0, textContent.indexOf(valueEl.textContent)).trim().replace(/:$/, '');
                        }
                        if (labelText && !labelText.startsWith("å…·ä½“å‚æ•°åœ¨å¯¹åº”çš„æ’è¡¨å¤„ä¿®æ”¹")) data.push([labelText, valueEl.textContent.trim()]);
                    }
                    else if (p.classList.contains('info-text') && p.id === 'bonus-gap-info' && textContent) data.push(['å‡‘å•å»ºè®®', textContent]);
                });
            });
            const orderPlanOutput = document.getElementById('order-plan-output');
            if (orderPlanOutput && orderPlanOutput.textContent.trim() !== "è¯·å…ˆå¡«å†™ä¸Šæ–¹ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»æŒ‰é’®ç”Ÿæˆæ–¹æ¡ˆ...") {
                data.push(['ã€ä¸‹å•æ–¹æ¡ˆã€‘', '---']);
                orderPlanOutput.textContent.split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        if (trimmedLine.startsWith('---') && trimmedLine.endsWith('---')) data.push([trimmedLine, '']);
                        else if (trimmedLine.includes(':')) { const parts = trimmedLine.split(':'); data.push([parts[0].trim(), parts.slice(1).join(':').trim()]); }
                        else data.push(['', trimmedLine]);
                    }
                });
            }
            return data;
        }

        function getTablesDataForExport() {
            const allSheetsData = {};

            orderedTypesForTabs.forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];
                const currentItemName = itemConfig.key;
                const sheetExportName = `æ’è¡¨-${currentItemName}`;

                const sheetData = [];

                if (!itemConfig.isDynamicTabContent) {
                    const configHeader = document.querySelector(`#table-${typeKey} .item-config-header`);
                    if (configHeader) {
                        sheetData.push(['é…ç½®é¡¹', 'å€¼']);
                        configHeader.querySelectorAll('.input-group').forEach(group => {
                            const labelEl = group.querySelector('label');
                            const inputEl = group.querySelector('input');
                            if (labelEl && inputEl) {
                                sheetData.push([labelEl.textContent, inputEl.value]);
                            }
                        });
                        sheetData.push([]);
                    }
                }

                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                const finalHeaderRow = [];
                let distributionHeaderOriginalIndex = -1;
                table.querySelectorAll('thead th').forEach((th, index) => {
                    const thText = th.textContent.replace(/<span.*<\/span>/g, '').trim();
                    if (thText === 'æ’è¡¨') { finalHeaderRow.push('åˆ†é…ç»™', 'æ•°é‡'); distributionHeaderOriginalIndex = index; }
                    else finalHeaderRow.push(thText);
                });
                sheetData.push(finalHeaderRow);
                table.querySelectorAll('tbody tr').forEach(row => {
                    const cells = Array.from(row.cells);
                    const rowDataPrefix = []; const rowDataSuffix = []; let currentDistributionEntries = [];
                    cells.forEach((td, cellIndex) => {
                        if (td.classList.contains('distribution-cell')) {
                            td.querySelectorAll('.dist-entry').forEach(entry => {
                                const name = entry.querySelector('.dist-name').value.trim();
                                const quantity = entry.querySelector('.dist-quantity').value.trim();
                                if (name || (quantity && quantity !== "0")) currentDistributionEntries.push({ name, quantity });
                            });
                        } else {
                            let cellValue = '';
                            const input = td.querySelector('input[type="text"], input[type="number"]');
                            if (input) cellValue = input.value;
                            else if (td.classList.contains('sticker-status') || td.classList.contains('avg-price') || td.classList.contains('final-price') || td.classList.contains('remaining-quantity')) cellValue = td.textContent.trim();
                            else { let textContent = td.cloneNode(true); textContent.querySelectorAll('button, span.warning-text').forEach(el => el.remove()); cellValue = textContent.textContent.trim(); }

                            if (distributionHeaderOriginalIndex === -1 || cellIndex < distributionHeaderOriginalIndex) {
                                rowDataPrefix.push(cellValue);
                            } else if (cellIndex > distributionHeaderOriginalIndex) {
                                rowDataSuffix.push(cellValue);
                            }
                        }
                    });
                    if (currentDistributionEntries.length > 0) {
                        currentDistributionEntries.forEach(distEntry => sheetData.push([...rowDataPrefix, distEntry.name, distEntry.quantity, ...rowDataSuffix]));
                    } else {
                        const emptyDist = (distributionHeaderOriginalIndex !== -1) ? ['', ''] : [];
                        sheetData.push([...rowDataPrefix, ...emptyDist, ...rowDataSuffix]);
                    }
                });
                allSheetsData[sheetExportName] = sheetData;
            });
            return allSheetsData;
        }

        function getSummaryDataForExport() {
            const sheets = {};
            const placeholderText = "ç‚¹å‡»æŒ‰é’®è®¡ç®—..."; const emptyTableMsg = "è¯·å…ˆåœ¨å„åˆ†è¡¨ä¸­å¡«å†™æ’è¡¨ä¿¡æ¯ã€‚";
            const billOutputEl = document.getElementById('total-bill-output');
            const billOutputText = billOutputEl ? billOutputEl.textContent : placeholderText;
            const billData = [['å›¢å‘˜', 'é‡‘é¢ (å…ƒ)']];
            if (billOutputText.trim() !== placeholderText && billOutputText.trim() !== emptyTableMsg && billOutputText.trim() !== "") {
                billOutputText.split('\n').forEach(line => {
                    line = line.trim();
                    if (line && line.includes(':')) { const parts = line.split(':'); const name = parts[0].trim(); const amountText = parts.slice(1).join(':').replace('å…ƒ', '').trim(); billData.push([name, parseFloat(amountText) || 0]); }
                });
            }
            sheets["æ€»è‚¾è¡¨"] = billData;
            const itemsOutputEl = document.getElementById('total-items-output');
            const itemsOutputText = itemsOutputEl ? itemsOutputEl.textContent : placeholderText;
            const itemsData = [['å›¢å‘˜', 'ç‰©å“', 'æ•°é‡']];
            if (itemsOutputText.trim() !== placeholderText && itemsOutputText.trim() !== emptyTableMsg && itemsOutputText.trim() !== "") {
                let currentPerson = null;
                itemsOutputText.split('\n').forEach(line => {
                    line = line.trim();
                    if (line.startsWith('--- ') && line.endsWith(' ---')) currentPerson = line.substring(4, line.length - 4).trim();
                    else if (currentPerson && line) { const parts = line.split(' x '); const itemName = parts[0].trim(); const quantityText = parts.length > 1 ? parts[1].trim() : '1'; itemsData.push([currentPerson, itemName, parseInt(quantityText, 10) || 1]); }
                });
            }
            sheets["æ€»æ’è¡¨"] = itemsData;
            const checkData = [['é¡¹ç›®', 'å€¼']];
            document.querySelectorAll('#check-total-output p').forEach(p => {
                let text = p.textContent.trim();
                const span = p.querySelector('span.result-field');
                if (span) { const label = text.substring(0, text.indexOf(span.textContent)).trim().replace(/:$/, ''); checkData.push([label, parseFloat(span.textContent) || 0]); }
                else if (p.id === 'check-diff' && text) checkData.push(['æ ¸å¯¹ä¿¡æ¯', text]);
            });
            sheets["è‚¾é¢æ ¸å¯¹"] = checkData;
            return sheets;
        }

        function exportCalculatorData() {
            const calcData = getCalculatorDataForExport();
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(calcData);
            const colWidths = calcData.reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 10, len + 2); }); return acc; }, []);
            ws['!cols'] = colWidths.map(w => ({ wch: Math.min(w, 50) }));
            XLSX.utils.book_append_sheet(wb, ws, "è®¡ç®—å™¨æ•°æ®");
            downloadExcelWorkbook(wb, `å¼€è°·ä¸€ä½“æœº-è®¡ç®—å™¨.xlsx`);
        }

        function exportTablesData() {
            const sheetsData = getTablesDataForExport();
            const wb = XLSX.utils.book_new();
            for (const sheetName in sheetsData) {
                const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                if (sheetsData[sheetName].length > 0) {
                    const colWidths = sheetsData[sheetName].reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 8, len + 1); }); return acc; }, []);
                    ws['!cols'] = colWidths.map(w => ({ wch: Math.min(w, 40) }));
                }
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
            downloadExcelWorkbook(wb, `å¼€è°·ä¸€ä½“æœº-æ’è¡¨.xlsx`);
        }

        function exportSummaryData() {
            calculateSummary();
            const sheetsData = getSummaryDataForExport();
            const wb = XLSX.utils.book_new();
            for (const sheetName in sheetsData) {
                const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                if (sheetsData[sheetName].length > 0) {
                    const colWidths = sheetsData[sheetName].reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 10, len + 2); }); return acc; }, []);
                    ws['!cols'] = colWidths.map(w => ({ wch: Math.min(w, 50) }));
                }
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
            downloadExcelWorkbook(wb, `å¼€è°·ä¸€ä½“æœº-è‚¾è¡¨.xlsx`);
        }

        function exportAllData() {
            const wb = XLSX.utils.book_new();
            const calcData = getCalculatorDataForExport();
            const wsCalc = XLSX.utils.aoa_to_sheet(calcData);
            const calcColWidths = calcData.reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 10, len + 2); }); return acc; }, []);
            wsCalc['!cols'] = calcColWidths.map(w => ({ wch: Math.min(w, 50) }));
            XLSX.utils.book_append_sheet(wb, wsCalc, "è®¡ç®—å™¨æ•°æ®");

            const tablesSheetsData = getTablesDataForExport();
            for (const sheetName in tablesSheetsData) {
                const wsTable = XLSX.utils.aoa_to_sheet(tablesSheetsData[sheetName]);
                if (tablesSheetsData[sheetName].length > 0) {
                    const tableColWidths = tablesSheetsData[sheetName].reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 8, len + 1); }); return acc; }, []);
                    wsTable['!cols'] = tableColWidths.map(w => ({ wch: Math.min(w, 40) }));
                }
                XLSX.utils.book_append_sheet(wb, wsTable, sheetName);
            }

            calculateSummary();
            const summarySheetsData = getSummaryDataForExport();
            for (const sheetName in summarySheetsData) {
                const wsSummary = XLSX.utils.aoa_to_sheet(summarySheetsData[sheetName]);
                if (summarySheetsData[sheetName].length > 0) {
                    const summaryColWidths = summarySheetsData[sheetName].reduce((acc, row) => { row.forEach((cell, i) => { const len = cell ? String(cell).length : 0; acc[i] = Math.max(acc[i] || 10, len + 2); }); return acc; }, []);
                    wsSummary['!cols'] = summaryColWidths.map(w => ({ wch: Math.min(w, 50) }));
                }
                XLSX.utils.book_append_sheet(wb, wsSummary, sheetName);
            }
            downloadExcelWorkbook(wb, `å¼€è°·ä¸€ä½“æœº-å…¨éƒ¨æ•°æ®.xlsx`);
        }

        function getFormattedDateTime() {
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${month}${day}${hours}${minutes}`;
        }

        function exportAllDataAsJson() {
            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            const dataToExport = allSaves[currentSlotName];
            if (!dataToExport) {
                alert("å½“å‰å­˜æ¡£æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºã€‚è¯·å…ˆè¿›è¡Œä¸€äº›æ“ä½œã€‚");
                return;
            }

            const jsonDataString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonDataString], { type: "application/json;charset=utf-8" });
            const fileName = `KeichiETJ-${currentSlotName}-${getFormattedDateTime()}.json`;

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            hideDataSyncModal();
        }

        function handleJsonFileImport(event) {
            const file = event.target.files[0];
            const importInput = document.getElementById('json-import-file');

            if (!file) {
                if (importInput) importInput.value = '';
                hideDataSyncModal();
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedJson = JSON.parse(e.target.result);
                    if (confirm(`å¯¼å…¥æ•°æ®å°†ä¼šè¦†ç›–å½“å‰å­˜æ¡£ã€${currentSlotName}ã€‘çš„å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ`)) {
                        loadData(importedJson);
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        if (document.getElementById('tables-section').classList.contains('active') && orderedTypesForTabs.length > 0) {
                            const firstValidTab = orderedTypesForTabs.find(key => itemTypes[key]);
                            if (firstValidTab) showItemTab(firstValidTab);
                        } else if (!document.querySelector('.tab-button.active')) {
                            showTab('calculator-section');
                        }
                    }
                } catch (error) {
                    console.error("å¯¼å…¥JSONæ–‡ä»¶å¤±è´¥:", error);
                    alert("å¯¼å…¥JSONæ–‡ä»¶å¤±è´¥ã€‚æ–‡ä»¶æ ¼å¼å¯èƒ½ä¸æ­£ç¡®æˆ–æ•°æ®ä¸å½“å‰ç‰ˆæœ¬ä¸å…¼å®¹ã€‚\né”™è¯¯è¯¦æƒ…: " + error.message);
                } finally {
                    if (importInput) importInput.value = '';
                    hideDataSyncModal();
                }
            };
            reader.onerror = () => {
                alert("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚");
                if (importInput) importInput.value = '';
                hideDataSyncModal();
            };
            reader.readAsText(file);
        }

        function addNewCustomItemType() {
            dynamicItemCounter++;
            const newTypeKey = `custom_item_${dynamicItemCounter}`;
            const newItemName = prompt("è¯·è¾“å…¥æ–°å•†å“ç±»å‹çš„åç§°:", `è‡ªå®šä¹‰å•†å“ ${dynamicItemCounter}`);

            if (!newItemName) {
                dynamicItemCounter--;
                return;
            }

            itemTypes[newTypeKey] = {
                id_prefix: newTypeKey,
                key: newItemName,
                defaults: { name: newItemName, price: '', chars: '0', sets: '0' },
                avgPriceId: `final-${newTypeKey}-price`,
                hasChars: true,
                hasSets: true,
                setsLabel: 'é…æ•°',
                isDynamic: true,
                isSticker: false,
                isDynamicTabContent: false
            };

            if (!orderedTypesForTabs.includes(newTypeKey)) {
                const singleIdx = orderedTypesForTabs.indexOf('single');
                const bonusIdx = orderedTypesForTabs.indexOf('bonus');
                let insertAtIndex = orderedTypesForTabs.length;
                if (singleIdx !== -1) insertAtIndex = singleIdx;
                else if (bonusIdx !== -1) insertAtIndex = bonusIdx;

                orderedTypesForTabs.splice(insertAtIndex, 0, newTypeKey);
            }

            const allSaves = JSON.parse(localStorage.getItem(SAVE_MANIFEST_KEY) || '{}');
            const currentData = allSaves[currentSlotName];
            const currentTablesData = currentData ? currentData.tables : {};

            generateTables(currentTablesData);
            calculateAll();
            calculateSummary();
            showItemTab(newTypeKey);
            saveData(false);
        }

        function removeDynamicItemType(typeKeyToRemove) {
            const itemConfigToRemove = itemTypes[typeKeyToRemove];
            if (!itemConfigToRemove || !itemConfigToRemove.isDynamic) {
                alert("æ— æ³•åˆ é™¤éåŠ¨æ€æˆ–ä¸å­˜åœ¨çš„å•†å“ç±»å‹ã€‚");
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤å•†å“ç±»å‹ "${itemConfigToRemove.key}" å—ï¼Ÿå…¶æ‰€æœ‰é…ç½®å’Œæ’è¡¨æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚`)) {
                delete itemTypes[typeKeyToRemove];
                orderedTypesForTabs = orderedTypesForTabs.filter(key => key !== typeKeyToRemove);

                const tabButtonToRemove = document.querySelector(`.item-tab-button[data-tab="${typeKeyToRemove}"]`);
                if (tabButtonToRemove) tabButtonToRemove.remove();

                const tableContentToRemove = document.getElementById(`table-${typeKeyToRemove}`);
                if (tableContentToRemove) tableContentToRemove.remove();

                const idPrefix = typeKeyToRemove;
                const openingDisplayParent = document.getElementById('dynamic-items-opening-display');
                const finalDiscountDisplayParent = document.getElementById('dynamic-items-final-discount-display');

                let hrToRemove = openingDisplayParent.querySelector(`hr[data-prefix="${idPrefix}"]`);
                if (hrToRemove) hrToRemove.remove();

                let priceGroupToRemove = document.getElementById(`${idPrefix}-price-label`)?.parentElement;
                if (priceGroupToRemove && priceGroupToRemove.parentElement === openingDisplayParent) priceGroupToRemove.remove();

                let setsGroupToRemove = document.getElementById(`${idPrefix}-sets-label`)?.parentElement;
                if (setsGroupToRemove && setsGroupToRemove.parentElement === openingDisplayParent) setsGroupToRemove.remove();

                let finalPricePToRemove = document.getElementById(`final-${idPrefix}-name-display`)?.parentElement;
                if (finalPricePToRemove && finalPricePToRemove.parentElement === finalDiscountDisplayParent) finalPricePToRemove.remove();

                calculateAll();
                calculateSummary();
                saveData(false);

                const activeItemTabButton = document.querySelector('#item-tabs .item-tab-button.active');
                if (!activeItemTabButton && document.getElementById('tables-section').classList.contains('active')) {
                    if (orderedTypesForTabs.length > 0) {
                        const firstValidTabKey = orderedTypesForTabs.find(key => itemTypes[key] && !itemTypes[key].isDynamicTabContent);
                        const fallbackTabKey = orderedTypesForTabs.find(key => itemTypes[key]);
                        if (firstValidTabKey) {
                            showItemTab(firstValidTabKey);
                        } else if (fallbackTabKey) {
                            showItemTab(fallbackTabKey);
                        } else {
                            showTab('calculator-section');
                        }
                    } else {
                        showTab('calculator-section');
                    }
                }
            }
        }
        let allCharacterNames = new Set();
        let allMemberNames = new Set();
        let allKindNames = new Set();

        function updateNameCaches() {
            allCharacterNames.clear();
            allMemberNames.clear();
            allKindNames.clear();

            // æ‰«ææ‰€æœ‰è§’è‰²åè¾“å…¥æ¡†
            document.querySelectorAll('input[placeholder="è§’è‰²å..."]').forEach(input => {
                if (input.value.trim()) {
                    allCharacterNames.add(input.value.trim());
                }
            });

            // æ‰«ææ‰€æœ‰å›¢å‘˜åè¾“å…¥æ¡†
            document.querySelectorAll('input.dist-name').forEach(input => {
                if (input.value.trim()) {
                    allMemberNames.add(input.value.trim());
                }
            });

            // æ‰«ææ‰€æœ‰ç§ç±»è¾“å…¥æ¡†ï¼ˆå•é¢†è¡¨æ ¼ä¸­çš„ï¼‰
            document.querySelectorAll('#data-table-single input[data-type="kind"]').forEach(input => {
                if (input.value.trim()) {
                    allKindNames.add(input.value.trim());
                }
            });
        }

        function setupAutocomplete() {
            const suggestionBox = document.getElementById('autocomplete-suggestions');
            let activeSuggestionInput = null;
            let activeSuggestionIndex = -1;

            // æ–°å¢ï¼šä¸€ä¸ªä¸“é—¨ç”¨æ¥é‡æ–°å®šä½è¡¥å…¨æ¡†çš„å‡½æ•°
            function repositionSuggestionBox() {
                if (!activeSuggestionInput) return; // å¦‚æœæ²¡æœ‰æ¿€æ´»çš„è¾“å…¥æ¡†ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
                const rect = activeSuggestionInput.getBoundingClientRect();
                suggestionBox.style.left = `${rect.left}px`;
                suggestionBox.style.top = `${rect.bottom}px`;
                suggestionBox.style.width = `${rect.width}px`;
            }

            function showSuggestions(inputElement, nameSet, filter = '') {
                const suggestions = [...nameSet].filter(name => name.toLowerCase().includes(filter.toLowerCase()));

                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }

                suggestionBox.innerHTML = '';
                suggestions.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = name;
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        inputElement.value = name;
                        hideSuggestions();
                        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                    suggestionBox.appendChild(item);
                });

                repositionSuggestionBox(); // ä½¿ç”¨æ–°çš„å®šä½å‡½æ•°æ¥è®¾ç½®ä½ç½®
                suggestionBox.style.display = 'block';
                activeSuggestionIndex = -1;
            }

            function hideSuggestions() {
                suggestionBox.style.display = 'none';
                activeSuggestionInput = null;
            }

            function handleKeyDown(e) {
                if (!activeSuggestionInput || suggestionBox.style.display === 'none') return;

                const items = suggestionBox.querySelectorAll('.suggestion-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length;
                    updateActiveSuggestion(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length;
                    updateActiveSuggestion(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestionIndex > -1) {
                        items[activeSuggestionIndex].dispatchEvent(new MouseEvent('mousedown'));
                    }
                    hideSuggestions();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hideSuggestions();
                }
            }

            function updateActiveSuggestion(items) {
                items.forEach(item => item.classList.remove('active'));
                if (activeSuggestionIndex > -1) {
                    items[activeSuggestionIndex].classList.add('active');
                    items[activeSuggestionIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            document.addEventListener('focusin', (e) => {
                const target = e.target;
                let nameSet = null;

                if (target.matches('input[placeholder="è§’è‰²å..."]')) {
                    nameSet = allCharacterNames;
                } else if (target.matches('input.dist-name')) {
                    nameSet = allMemberNames;
                } else if (target.matches('#data-table-single input[data-type="kind"]')) { // æ–°å¢ï¼šå•é¢†è¡¨æ ¼çš„ç§ç±»è¾“å…¥æ¡†
                    nameSet = allKindNames;
                }

                if (nameSet) {
                    activeSuggestionInput = target;
                    updateNameCaches();
                    showSuggestions(target, nameSet, target.value);
                }
            });


            document.addEventListener('input', (e) => {
                if (e.target === activeSuggestionInput) {
                    let nameSet = null;
                    if (e.target.matches('input[placeholder="è§’è‰²å..."]')) {
                        nameSet = allCharacterNames;
                    } else if (e.target.matches('input.dist-name')) {
                        nameSet = allMemberNames;
                    } else if (e.target.matches('#data-table-single input[data-type="kind"]')) { // æ–°å¢ï¼šå•é¢†è¡¨æ ¼çš„ç§ç±»è¾“å…¥æ¡†
                        nameSet = allKindNames;
                    }
                    if (nameSet) {
                        showSuggestions(e.target, nameSet, e.target.value);
                    }
                }
            });


            document.addEventListener('click', (e) => {
                if (e.target !== activeSuggestionInput && !suggestionBox.contains(e.target)) {
                    hideSuggestions();
                }
            });

            document.addEventListener('blur', (e) => {
                if (e.target.matches('input[placeholder="è§’è‰²å..."]') ||
                    e.target.matches('input.dist-name') ||
                    e.target.matches('#data-table-single input[data-type="kind"]')) { // æ–°å¢ï¼šå•é¢†è¡¨æ ¼çš„ç§ç±»è¾“å…¥æ¡†
                    updateNameCaches();
                }
            }, true);


            document.addEventListener('keydown', handleKeyDown);

            // ç›‘å¬æ»šåŠ¨å’Œçª—å£å¤§å°å˜åŒ–äº‹ä»¶
            const updatePositionOnScrollOrResize = () => {
                if (suggestionBox.style.display === 'block') {
                    repositionSuggestionBox();
                }
            };
            window.addEventListener('scroll', updatePositionOnScrollOrResize, true);
            window.addEventListener('resize', updatePositionOnScrollOrResize);
        }



        function updateRemainingTable() {
            const outputDiv = document.getElementById('remaining-output');
            const inputs = getInputs();

            // æ›´æ–°æ‰€æœ‰ä½™é‡æ•°å€¼ï¼ˆç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„ï¼‰
            updateAllRemainingQuantities();

            const remainingData = {};

            // éå†æ‰€æœ‰å•†å“ç±»å‹
            Object.keys(itemTypes).forEach(typeKey => {
                const itemConfig = itemTypes[typeKey];

                // åªè·³è¿‡'single'ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ä½™é‡æ¦‚å¿µ
                if (typeKey === 'single') return;

                const table = document.getElementById(`data-table-${typeKey}`);
                if (!table) return;

                const currentItemName = itemConfig.key;
                if (!remainingData[currentItemName]) {
                    remainingData[currentItemName] = [];
                }

                table.querySelectorAll('tbody tr').forEach(row => {
                    const remainingCell = row.querySelector('.remaining-quantity');
                    if (!remainingCell) return;

                    const remainingValue = remainingCell.textContent.trim();
                    if (remainingValue === 'N/A' || remainingValue === '') return;

                    const remainingNum = parseFloat(remainingValue);
                    if (isNaN(remainingNum) || remainingNum === 0) return; // åªæ˜¾ç¤ºéé›¶ä½™é‡

                    // è·å–ä»·æ ¼ä¿¡æ¯
                    const finalPriceCell = row.querySelector('.final-price');
                    const price = finalPriceCell ? (parseFloat(finalPriceCell.textContent) || 0) : 0;

                    let itemIdentifier = '';

                    if (typeKey === 'bonus') {
                        const tierInput = row.querySelector('input[data-type="kind"]');
                        const customKind = row.querySelector('.custom-kind')?.value;
                        const tierText = tierInput ? tierInput.value : 'æœªçŸ¥ç‰¹å…¸';
                        itemIdentifier = customKind ? `${tierText} - ${customKind}` : tierText;
                    } else if (typeKey === 'single') {
                        const kindInput = row.querySelector('input[data-type="kind"]');
                        itemIdentifier = kindInput ? kindInput.value : 'æœªçŸ¥ç§ç±»';
                    } else {
                        const charNameInput = row.querySelector('input[placeholder="è§’è‰²å..."]');
                        itemIdentifier = charNameInput ? (charNameInput.value || `è§’è‰²${row.dataset.index}`) : `é¡¹ç›®${row.dataset.index}`;
                    }

                    remainingData[currentItemName].push({
                        name: itemIdentifier,
                        price: price,
                        remaining: remainingNum
                    });
                });
            });

            // ç”ŸæˆHTMLè¾“å‡º
            let html = '';
            let hasAnyRemaining = false;

            Object.keys(remainingData).forEach(itemTypeName => {
                const items = remainingData[itemTypeName];
                if (items.length === 0) return;

                hasAnyRemaining = true;
                html += `<div class="calc-section" style="margin-bottom: 20px;">`;
                html += `<h3 style="margin-top: 0;">${itemTypeName}</h3>`;
                html += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">`;
                html += `<thead><tr>`;
                html += `<th style="text-align: left; padding: 8px; background-color: var(--highlight-bg); border: 1px solid var(--border-color);">é¡¹ç›®</th>`;
                html += `<th style="text-align: center; padding: 8px; background-color: var(--highlight-bg); border: 1px solid var(--border-color); width: 100px;">ä»·æ ¼</th>`;
                html += `<th style="text-align: center; padding: 8px; background-color: var(--highlight-bg); border: 1px solid var(--border-color); width: 100px;">ä½™é‡</th>`;
                html += `</tr></thead>`;
                html += `<tbody>`;

                items.forEach(item => {
                    const remainingClass = item.remaining > 0 ? 'style="color: var(--success-color); font-weight: bold;"' :
                        item.remaining < 0 ? 'style="color: var(--accent-color); font-weight: bold;"' : '';
                    html += `<tr>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--border-color);">${item.name}</td>`;
                    html += `<td style="text-align: center; padding: 8px; border: 1px solid var(--border-color);">${item.price.toFixed(2)}</td>`;
                    html += `<td style="text-align: center; padding: 8px; border: 1px solid var(--border-color);" ${remainingClass}>${item.remaining}</td>`;
                    html += `</tr>`;
                });

                html += `</tbody></table></div>`;
            });

            if (!hasAnyRemaining) {
                html = '<p style="color: var(--light-text-color); text-align: center; font-style: italic; margin-top: 20px;">æš‚æ— ä½™é‡æ•°æ®ï¼Œæˆ–æ‰€æœ‰å•†å“ä½™é‡å‡ä¸º0ã€‚</p>';
            }

            outputDiv.innerHTML = html;
        }


        function copyToClipboard(elementId, buttonElement) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let textToCopy = element.innerText || element.textContent;

            // å¯¹äºHTMLè¡¨æ ¼ï¼Œæå–çº¯æ–‡æœ¬
            if (element.querySelector('table')) {
                textToCopy = '';
                const tables = element.querySelectorAll('table');
                const headers = element.querySelectorAll('h3');

                let headerIndex = 0;
                tables.forEach(table => {
                    if (headers[headerIndex]) {
                        textToCopy += headers[headerIndex].textContent.trim() + '\n';
                        headerIndex++;
                    }

                    table.querySelectorAll('tr').forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        const rowText = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
                        textToCopy += rowText + '\n';
                    });
                    textToCopy += '\n';
                });
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                buttonElement.classList.add('copied');

                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶ã€‚');
            });
        }

    </script>
    <div id="autocomplete-suggestions"></div>
</body>

</html>
